<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L2H - Dashboard Financiero</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Dashboard financiero para an√°lisis de movimientos bancarios de Lomas 2 Comunidad de Vecinos">
    <meta name="theme-color" content="#22303B">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="L2H Dashboard">
    
    <!-- Icons -->
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="icon" type="image/x-icon" href="/L2H_logo.ico">

    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZpbmFuY2UgRGFzaGJvYXJkIExvbWFzIDIiLAogICJzaG9ydF9uYW1lIjogIkwySCBEYXNoYm9hcmQiLAogICJkZXNjcmlwdGlvbiI6ICJBbsOhbGlzaXMgeSBzZWd1aW1pZW50byBkZSB0cmFuc2FjY2lvbmVzIGJhbmNhcmlhcyIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZjhmOWZhIiwKICAidGhlbWVfY29sb3IiOiAiIzIyMzAzQiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImxvZ28ucG5nIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9LAogICAgewogICAgICAic3JjIjogImxvZ28ucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    
    <style>
        :root {
            --font-primary: 'Roboto', sans-serif;
            --font-monospace: 'Roboto Mono', monospace;
            --bg-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 6px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --color-ingresos: #20c997;
            --color-gastos: #dc3545;
            --color-per-home: #6f42c1;
            --color-balance: #0d6efd;
            --color-transacciones: #fd7e14;
            --color-saldo-minimo: #0dcaf0;
            --color-header-bg: #f8f9fa;
            --color-total-bg: #343a40;
            --color-selected: #0d6efd;
            --color-selected-bg: #e7f3ff;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: var(--font-primary);
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-primary);
        }

        #financial-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0;
        }

        /* Asegurar ancho completo para contenedores principales */
        .dashboard-header,
        .active-filters,
        .db-container,
        .kpi-cards,
        .chart-grid {
            width: 100%;
        }

        .db-container {
            background: var(--card-bg-color);
            padding: 24px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            box-sizing: border-box;
        }

        .db-container-title {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Asegurar que los t√≠tulos con botones se distribuyan correctamente */
        .db-container-title > span:first-child {
            flex: 0 1 auto;
        }
        
        .db-container-title small {
            flex: 0 1 auto;
        }

        /* KPI Cards */
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
            width: 100%;
            box-sizing: border-box;
        }

        .kpi-card {
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .kpi-card h3 {
            margin: 0 0 12px 0;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-card .value {
            font-size: 28px;
            font-weight: 700;
            font-family: var(--font-monospace);
            margin-bottom: 8px;
        }

        .kpi-card .trend {
            font-size: 14px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .trend.positive {
            background: #d4edda;
            color: #155724;
        }

        .trend.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .kpi-card small {
            color: var(--text-secondary);
            font-size: 11px;
            display: block;
            margin-top: 8px;
        }

        .kpi-card.ingresos { border-top: 4px solid var(--color-ingresos); }
        .kpi-card.ingresos .value { color: var(--color-ingresos); }
        .kpi-card.gastos { border-top: 4px solid var(--color-gastos); }
        .kpi-card.gastos .value { color: var(--color-gastos); }
        .kpi-card.per-home { border-top: 4px solid var(--color-per-home); }
        .kpi-card.per-home .value { color: var(--color-per-home); }
        .kpi-card.balance { border-top: 4px solid var(--color-balance); }
        .kpi-card.balance .value { color: var(--color-balance); }
        .kpi-card.transacciones { border-top: 4px solid var(--color-transacciones); }
        .kpi-card.transacciones .value { color: var(--color-transacciones); }

        /* Filters */
        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card-bg-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-primary);
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--color-balance);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }

        /* Active Filters Panel */
        .active-filters {
            display: none; /* Hide by default */
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            padding: 16px 24px;
            background: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            width: 100%;
            box-sizing: border-box;
        }

        .active-filters.visible {
            display: flex;
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border: 1px solid var(--color-selected);
            border-radius: 20px;
            font-size: 13px;
            color: var(--color-selected);
            font-weight: 500;
        }

        .filter-badge .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .filter-badge .remove:hover {
            opacity: 1;
        }

        .clear-all-btn {
            padding: 8px 16px;
            border: 1px solid #e74c3c;
            border-radius: 20px;
            background: #e74c3c;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap; /* Evitar que el bot√≥n se divida en varias l√≠neas */
            flex-shrink: 0; /* No permitir que se encoja */
            width: auto; /* Ancho autom√°tico basado en contenido */
        }

        .clear-all-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 56px;
            height: 56px;
            background-color: var(--color-gastos);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out, bottom 0.3s ease-in-out;
            transform: scale(1);
            opacity: 1;
        }

        .fab:hover {
            background-color: #c0392b; /* Darker red */
            transform: scale(1.05);
        }

        /* FAB icon layout: show funnel and small X */
        .fab .fab-icon { display: inline-flex; align-items: center; justify-content: center; }
        .fab .fab-icon svg { width: 12px; height: 12px; fill: white; }
        .fab .fab-x { display: inline-block; font-size: 12px; line-height: 1; margin-left: 6px; }

        /* FAB Confirm - Verde */
        .fab-confirm {
            background-color: #28a745;
            right: 30px;
            bottom: 100px; /* Encima del FAB principal */
        }

        .fab-confirm:hover {
            background-color: #218838;
            transform: scale(1.05);
        }

        /* FAB Cancel - Rojo */
        .fab-cancel {
            background-color: #dc3545;
            right: 30px;
            bottom: 170px; /* M√°s arriba */
        }

        .fab-cancel:hover {
            background-color: #c82333;
            transform: scale(1.05);
        }

        /* Icon buttons for confirm/cancel (compact circular style) */
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
            padding: 0;
            line-height: 1;
        }

        .icon-confirm {
            background: #28a745; /* green */
            color: white;
            border-color: rgba(40,167,69,0.95);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(40,167,69,0.12);
            font-size: 14px;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .icon-cancel {
            /* High-contrast destructive button: solid red background with white X */
            background: #dc3545;
            color: #ffffff;
            border-color: rgba(220,53,69,0.95);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(220,53,69,0.14);
            font-size: 14px;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:focus {
            outline: 3px solid rgba(13,110,253,0.16);
            outline-offset: 2px;
        }

        .icon-confirm:hover, .icon-cancel:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 14px rgba(0,0,0,0.12);
        }

        .icon-cancel:active {
            transform: translateY(0) scale(0.99);
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        /* Hide per-section icons by default; shown only when pending selections exist */
        #top-confirm-icon, #top-cancel-icon,
        #cat-confirm-icon, #cat-cancel-icon,
        #monthly-confirm-icon, #monthly-cancel-icon,
        #expenses-confirm-icon, #expenses-cancel-icon,
        #all-confirm-icon, #all-cancel-icon {
            display: none;
        }

        /* Pending selection visual */
        .pending-selected { background-color: rgba(13,110,253,0.08); }
        
        /* Table containers with horizontal scroll */
        .table-scroll-wrapper {
            width: 100%;
            overflow-x: auto;
            overflow-y: visible;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 16px;
            position: relative;
            box-sizing: border-box;
        }
        
        /* Asegurar que la tabla use todo el ancho disponible */
        .table-scroll-wrapper .db-table {
            width: 100%;
            min-width: 100%; /* La tabla siempre ocupa el 100% del contenedor */
        }
        
        /* Scrollbar styling for better UX */
        .table-scroll-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-scroll-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-scroll-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .table-scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .chart-grid-double {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        /* Tables */
        .db-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed; /* Distribuci√≥n fija para ocupar todo el ancho */
        }

        .db-table th, .db-table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word;
        }
        
        /* Columnas espec√≠ficas con anchos optimizados */
        .db-table th:first-child,
        .db-table td:first-child {
            width: 10%; /* Fecha o Tipo */
        }
        
        .db-table .text-right {
            text-align: right;
            width: 12%; /* Valores num√©ricos */
        }
        
        /* Columnas de categor√≠a y concepto toman m√°s espacio */
        .db-table th:nth-child(2),
        .db-table td:nth-child(2) {
            width: 15%; /* Categor√≠a */
        }
        
        .db-table th:nth-child(3),
        .db-table td:nth-child(3) {
            width: 25%; /* Concepto - m√°s espacio */
        }

        .db-table thead tr {
            background-color: var(--color-header-bg);
        }

        .db-table th {
            font-weight: 600;
            color: var(--text-primary);
            border-bottom-width: 2px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .db-table th:hover {
            background-color: #e9ecef;
        }

        .db-table th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }

        .db-table th.sorted-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        .db-table th.sorted-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        /* Clases de ordenamiento alternativas */
        .db-table th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        .db-table th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        .db-table .text-right { text-align: right; }
        .db-table .text-center { text-align: center; }
        .db-table .color-ingresos { color: var(--color-ingresos); }
        .db-table .color-gastos { color: var(--color-gastos); }
        .db-table .color-per-home { color: var(--color-per-home); }
        .db-table .color-secondary { color: var(--text-secondary); }

        .db-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .db-table tbody tr.interactive-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .db-table tbody tr.selected {
            background-color: var(--color-selected-bg);
            border-left: 3px solid var(--color-selected);
        }

        .db-table tfoot tr {
            background-color: var(--color-total-bg);
            color: white;
            font-weight: 600;
        }

        .db-table tfoot td {
            border-top: 2px solid #000;
        }

        /* Compact table style for data-heavy tables (smaller rows) */
        .db-table.compact th, .db-table.compact td {
            padding: 8px 10px;
            font-size: 12px;
        }
        .db-table.compact tbody tr { line-height: 1.15; }

        /* Search and Actions Bar */
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 16px;
            flex-wrap: wrap;
            width: 100%;
            box-sizing: border-box;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
            position: relative;
            box-sizing: border-box;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--color-balance);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }

        .search-box::after {
            content: 'üîç';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .action-btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .action-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding: 16px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--color-balance);
            color: white;
            border-color: var(--color-balance);
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination .page-info {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Loading & Error */
        #loading {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
            font-size: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        #error {
            display: none;
            background: #fff5f5;
            color: #c53030;
            padding: 16px 20px;
            border-radius: 4px;
            text-align: center;
            margin-top: 20px;
            border: 1px solid #fed7d7;
            font-weight: 500;
        }

        /* Responsive */
        /* ============================================================================
           RESPONSIVE DESIGN - MOBILE OPTIMIZATIONS
           ============================================================================ */
        
        /* Tablets y pantallas medianas */
        @media (max-width: 992px) {
            .chart-grid-double {
                grid-template-columns: 1fr; /* Una sola columna en tablets y m√≥viles */
                gap: 16px;
            }
            
            .chart-grid {
                gap: 16px;
            }
            
            /* Asegurar que los contenedores usen todo el ancho */
            .db-container {
                width: 100%;
                padding: 16px;
                margin-bottom: 16px;
                box-sizing: border-box;
            }
            
            /* Optimizar tablas para tablets */
            .db-table th,
            .db-table td {
                padding: 10px 6px;
                font-size: 12px;
            }
            
            .table-scroll-wrapper .db-table {
                min-width: 100%; /* Tablets tambi√©n usan 100% */
            }
            
            .db-table thead,
            .db-table tbody,
            .db-table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
        }

        /* Tablets peque√±os y m√≥viles grandes */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }
            
            #financial-dashboard {
                max-width: 100%;
            }
            
            /* KPI Cards - 2 columnas en tablet */
            .kpi-cards {
                width: 100%;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                box-sizing: border-box;
            }
            
            .kpi-card {
                padding: 16px;
            }
            
            .kpi-card h3 {
                font-size: 11px;
                padding-bottom: 6px;
                margin-bottom: 10px;
            }
            
            .kpi-card .value {
                font-size: 22px;
            }
            
            /* Filtros - Una columna */
            .filters-container {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            /* Gr√°ficos - altura consistente */
            .chart-wrapper {
                height: 300px;
            }
            
            /* Asegurar apilamiento vertical en tablets peque√±os */
            .chart-grid-double {
                grid-template-columns: 1fr; /* Una sola columna */
            }
            
            /* Tablas responsive con scroll */
            #all-transactions-table {
                max-height: 500px;
                overflow-y: auto;
                overflow-x: auto;
            }
            
            .db-table.compact th,
            .db-table.compact td {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            /* Actions bar responsive */
            .actions-bar {
                width: 100%;
                flex-direction: column;
                gap: 12px;
                box-sizing: border-box;
            }
            
            .search-box {
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
            }
        }

        /* M√≥viles */
        @media (max-width: 576px) {
            body {
                padding: 8px;
                padding-bottom: 80px; /* Espacio para FAB */
            }
            
            .chart-grid,
            .chart-grid-double {
                width: 100%;
                grid-template-columns: 1fr; /* Una sola columna en m√≥viles */
                gap: 12px;
                box-sizing: border-box;
            }
            
            /* KPI Cards - 1 columna en m√≥vil */
            .kpi-cards {
                width: 100%;
                grid-template-columns: 1fr;
                gap: 10px;
                box-sizing: border-box;
            }
            
            .kpi-card {
                padding: 14px;
            }
            
            .kpi-card h3 {
                font-size: 11px;
                padding-bottom: 6px;
                margin-bottom: 10px;
            }
            
            .kpi-card .value {
                font-size: 24px;
            }
            
            /* Contenedores m√°s compactos */
            .db-container {
                width: 100%;
                padding: 12px;
                margin-bottom: 12px;
                box-sizing: border-box;
            }
            
            .db-container-title {
                font-size: 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                padding-bottom: 8px;
                margin-bottom: 16px;
            }
            
            .db-container-title small {
                font-size: 10px;
            }
            
            /* Gr√°ficos m√°s peque√±os en m√≥vil */
            .chart-wrapper {
                height: 250px;
            }
            
            /* Tablas ultra-compactas en m√≥vil */
            .db-table {
                font-size: 11px;
                table-layout: fixed; /* Mantener distribuci√≥n fija en m√≥vil */
            }
            
            .db-table th,
            .db-table td {
                padding: 8px 4px;
            }
            
            .table-scroll-wrapper .db-table {
                min-width: 100%; /* En m√≥vil tambi√©n usa 100% para ocupar todo el espacio */
            }
            
            .db-table.compact th,
            .db-table.compact td {
                padding: 6px 4px;
                font-size: 10px;
            }
            
            /* FAB m√°s peque√±o */
            .fab {
                width: 50px;
                height: 50px;
                right: 16px;
                bottom: 16px;
                font-size: 12px;
            }
            
            /* FAB Confirm en m√≥vil */
            .fab-confirm {
                bottom: 80px; /* M√°s cerca en m√≥vil */
            }
            
            /* FAB Cancel en m√≥vil */
            .fab-cancel {
                bottom: 144px; /* Ajustado para m√≥vil */
            }
            
            /* Active filters responsive */
            .active-filters {
                width: 100%;
                padding: 12px;
                gap: 8px;
                box-sizing: border-box;
            }
            
            .filter-badge {
                font-size: 12px;
                padding: 4px 10px;
            }
            
            .clear-all-btn {
                width: 100%; /* En m√≥vil, bot√≥n de ancho completo */
                justify-content: center;
                margin-top: 4px;
            }
            
            /* Paginaci√≥n responsive */
            .pagination {
                padding: 12px 8px;
                gap: 6px;
                flex-wrap: wrap;
            }
            
            .pagination button {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .pagination .page-info {
                font-size: 12px;
                width: 100%;
                text-align: center;
                margin-bottom: 8px;
            }
            
            /* Disclaimer m√°s compacto */
            .db-container p {
                font-size: 12px !important;
            }
            
            /* Header dashboard responsive */
            .dashboard-header {
                width: 100%;
                margin-bottom: 16px;
                box-sizing: border-box;
            }
            
            .dashboard-title {
                font-size: 18px;
                padding-bottom: 6px;
            }
            
            .dashboard-subtitle {
                font-size: 12px;
                margin-top: 6px;
            }
        }
        
        /* M√≥viles muy peque√±os */
        @media (max-width: 400px) {
            body {
                padding: 6px;
            }
            
            .kpi-card .value {
                font-size: 20px;
            }
            
            .chart-wrapper {
                height: 220px;
            }
            
            .db-table {
                font-size: 10px;
            }
            
            .action-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
        
        /* Asegurar scroll horizontal suave en todas las tablas */
        .db-table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Specific styling for table containers */
        #all-transactions-table,
        #category-summary-table,
        #top-movements-table { 
            font-family: var(--font-primary);
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
        }
        
/* --- INICIO DE MODIFICACI√ìN (L√≥gica Invertida) --- */
        /* L√≥gica de columnas secretas para Concepto */
        
        /* Por defecto (bloqueado):
           - .col-secreta (Concepto Real) est√° VISIBLE.
           - .col-concepto-original est√° OCULTA.
        */
        .col-secreta {
            display: table-cell; /* <-- CAMBIADO */
        }
        .col-concepto-original {
            display: none; /* <-- CAMBIADO */
        }

        /* Desbloqueado (cuando el contenedor tiene .show-secret-col):
           - .col-secreta (Concepto Real) se OCULTA.
           - .col-concepto-original se MUESTRA.
        */
        #all-transactions-table.show-secret-col .col-secreta {
            display: none; /* <-- CAMBIADO */
        }
        #all-transactions-table.show-secret-col .col-concepto-original {
            display: table-cell; /* <-- CAMBIADO */
        }
        /* --- FIN DE MODIFICACI√ìN --- */

        /* Dashboard header styles */
        .dashboard-header { 
            display: flex; 
            align-items: flex-start; 
            gap: 12px; 
            margin-bottom: 24px;
            width: 100%;
            box-sizing: border-box;
        }

        @keyframes windowShine {
            0% { background-position: 200% 200%; }
            100% { background-position: -200% -200%; }
        }

        @media (max-width: 768px) {
            .logo { gap: 16px; }
            .icon { 
                width: 90px;
                height: 74px;
                padding-left: 5px;
            }
            .house {
                width: 64px;
                height: 56px;
                border-width: 7px;
                padding: 10px 8px;
                gap: 7px;
            }
            .window { width: 15px; height: 15px; }
            .little-house {
                width: 30px;
                height: 28px;
                border-width: 7px;
                left: -5px;
                bottom: -9px;
            }
            .roof {
                top: -22px;
                border-left-width: 38px;
                border-right-width: 38px;
                border-bottom-width: 22px;
            }
            .l2h { font-size: 44px; }
            .lomas2 { font-size: 14px; }
            .comunidad { font-size: 11px; }
        }

        @media (max-width: 520px) {
            .logo { gap: 12px; }
            .icon {
                width: 72px;
                height: 58px;
                padding-left: 4px;
            }
            .house {
                width: 52px;
                height: 46px;
                border-width: 6px;
                padding: 9px;
                gap: 6px;
            }
            .window { width: 12px; height: 12px; }
            .little-house {
                width: 26px;
                height: 24px;
                border-width: 6px;
                left: -4px;
                bottom: -8px;
            }
            .roof {
                top: -18px;
                border-left-width: 32px;
                border-right-width: 32px;
                border-bottom-width: 18px;
            }
            .l2h { font-size: 34px; }
            .lomas2 { font-size: 13px; }
            .comunidad { font-size: 11px; }
        }

        .dashboard-title { 
            margin: 0 0 6px 0; 
            font-size: 22px; 
            font-weight: 700; 
            color: var(--text-primary); 
            letter-spacing: 0.2px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dashboard-subtitle { 
            margin: 8px 0 0 0; 
            color: var(--text-secondary); 
            font-size: 13px;
            font-weight: 400;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <!-- favicon: minimalist house icon matching the new logo design -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 45'%3E%3Cpath d='M35 20v25H0V20L17.5 0 35 20z' fill='%23E8D9C0'/%3E%3Cpath d='M20 25v20H0V25L10 12l10 13z' fill='%236E98C3'/%3E%3Crect x='5' y='28' width='8' height='8' fill='%2322303B'/%3E%3Crect x='22' y='28' width='8' height='8' fill='%2322303B'/%3E%3C/svg%3E">
</head>
<body>
    <div id="financial-dashboard">
        <div class="db-container" style="background-color: #fff3cd; border-color: #ffeeba; margin-bottom: 16px;">
            <p style="color: #856404; margin: 0; font-size: 14px;">
                <strong data-i18n="important_note">Nota importante:</strong> 
                <span data-i18n="disclaimer_text">Los saldos bancarios no incluye las facturas pendientes (impagadas o sin registrar). 
                El reparto de gastos 'Per Home' es un promedio simple (total de gastos / 160) y no considera el coeficiente de participaci√≥n espec√≠fico de cada propietario.</span>
            </p>
        </div>
        <div class="dashboard-header">
            <div>
                <h1 id="dashboard-title" class="dashboard-title">Movimientos Bancarios</h1>
                <p id="dashboard-subtitle" class="dashboard-subtitle">An√°lisis y seguimiento de transacciones bancarias</p>
            </div>
        </div>

        <div id="active-filters" class="active-filters">
            <strong style="font-size: 13px;" data-i18n="active_filters">Filtros activos:</strong>
            <div id="filter-badges" style="flex-grow: 1; display: flex; flex-wrap: wrap; gap: 8px;"></div>
            <button class="clear-all-btn" onclick="window.clearAllFilters()" data-i18n="clear_all">‚úï Limpiar todos</button>
        </div>
        <div class="db-container">
            <h3 class="db-container-title" data-i18n="filters">
                üîç Filtros
            </h3>
            <div class="filters-container">
                <div class="filter-group" style="max-width: 120px;">
                    <label for="language-select" data-i18n="label_language">üåê Idioma:</label>
                    <select id="language-select" class="filter-select">
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="en">üá¨üáß English</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filter-select" data-i18n="quick_period">Per√≠odo r√°pido:</label>
                    <select id="filter-select" class="filter-select">
                        <option value="all" data-i18n="all_data">Todos los datos</option>
                        <option value="current_month" data-i18n="current_month">Mes actual</option>
                        <option value="current_year" selected data-i18n="current_year">A√±o actual</option>
                        <option value="last_3_months" data-i18n="last_3_months">√öltimos 3 meses</option>
                        <option value="last_6_months" data-i18n="last_6_months">√öltimos 6 meses</option>
                        <option value="last_12_months" data-i18n="last_12_months">√öltimos 12 meses</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="start-date-select" data-i18n="from_date">Fecha desde:</label>
                    <input type="month" id="start-date-select" class="filter-input">
                </div>

                <div class="filter-group">
                    <label for="end-date-select" data-i18n="to_date">Fecha hasta:</label>
                    <input type="month" id="end-date-select" class="filter-input">
                </div>
            </div>
            <div id="last-update-date" style="text-align: right; font-size: 12px; color: var(--text-secondary); margin-top: 10px;">
                </div>
        </div>

        <div class="kpi-cards">
            <div class="kpi-card ingresos">
                <h3 data-i18n="kpi_total_ingresos">Total Ingresos</h3>
                <div id="total-ingresos" class="value">‚Ç¨0,00</div>
                <div id="trend-ingresos" class="trend" style="display: none;"></div>
                <small data-i18n="kpi_total_ingresos_note">Suma de ingresos</small>
            </div>
            <div class="kpi-card gastos">
                <h3 data-i18n="kpi_total_gastos">Total Gastos</h3>
                <div id="total-gastos" class="value">‚Ç¨0,00</div>
                <div id="trend-gastos" class="trend" style="display: none;"></div>
                <small data-i18n="kpi_total_gastos_note">Suma de gastos</small>
            </div>
            <div class="kpi-card per-home">
                <h3 data-i18n="kpi_total_per_home">Total Per Home</h3>
                <div id="total-per-home" class="value">‚Ç¨0,00</div>
                <div id="trend-per-home" class="trend" style="display: none;"></div>
                <small data-i18n="kpi_total_per_home_note">Gastos per home</small>
            </div>
            <div class="kpi-card balance">
                <h3 data-i18n="kpi_balance_actual">Balance Actual</h3>
                <div id="saldo-final" class="value">‚Ç¨0,00</div>
                <small data-i18n="kpi_balance_actual_note">Saldo m√°s reciente (global)</small>
            </div>
            <div class="kpi-card transacciones">
                <h3 data-i18n="kpi_transacciones">Transacciones</h3>
                <div id="total-transacciones" class="value">0</div>
                <small data-i18n="kpi_transacciones_note">Registros procesados</small>
            </div>
        </div>

        <div class="chart-grid">
            <div class="db-container">
                <h3 class="db-container-title">
                    <span data-i18n="monthly_movements">üìà Movimientos bancarios mensuales</span>
                    <small style="font-size: 11px; font-weight: normal; opacity: 0.7;" data-i18n="click_points">(Click en puntos para filtrar por mes)</small>
                    <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
                        <button id="monthly-confirm-icon" class="icon-btn icon-confirm" title="Confirmar selecci√≥n" onclick="window.applyPendingSelection()" aria-label="Confirmar selecci√≥n">‚úì</button>
                        <button id="monthly-cancel-icon" class="icon-btn icon-cancel" title="Cancelar selecci√≥n" onclick="window.clearPendingSelection()" aria-label="Cancelar selecci√≥n">
                            <svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg>
                        </button>
                    </div>
                </h3>
                <div class="chart-wrapper">
                    <canvas id="monthly-flow-chart"></canvas>
                </div>
            </div>
            
            <div class="chart-grid-double">
                <div class="db-container">
                    <h3 class="db-container-title">
                            <span data-i18n="top_movements">üèÜ Top Movimientos por categor√≠a</span>
                            <small style="font-size: 11px; font-weight: normal; opacity: 0.7;" data-i18n="highest_moves">(Mayores ingresos o gastos)</small>
                            <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
                                <button id="top-confirm-icon" class="icon-btn icon-confirm" title="Confirmar selecci√≥n" onclick="window.applyPendingSelection()" aria-label="Confirmar selecci√≥n">‚úì</button>
                                <button id="top-cancel-icon" class="icon-btn icon-cancel" title="Cancelar selecci√≥n" onclick="window.clearPendingSelection()" aria-label="Cancelar selecci√≥n">
                                    <svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg>
                                </button>
                            </div>
                        </h3>
                    <div id="top-movements-table">
                        </div>
                    
                </div>
                
                <div class="db-container">
                    <h3 class="db-container-title">
                        <span data-i18n="expenses_by_category">üìä Gastos por categor√≠a</span>
                        <small style="font-size: 11px; font-weight: normal; opacity: 0.7;" data-i18n="click_to_filter">(Click para filtrar)</small>
                        <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
                            <button id="expenses-confirm-icon" class="icon-btn icon-confirm" title="Confirmar selecci√≥n" onclick="window.applyPendingSelection()" aria-label="Confirmar selecci√≥n">‚úì</button>
                            <button id="expenses-cancel-icon" class="icon-btn icon-cancel" title="Cancelar selecci√≥n" onclick="window.clearPendingSelection()" aria-label="Cancelar selecci√≥n">
                                <svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg>
                            </button>
                        </div>
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="expenses-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="db-container">
            <h3 class="db-container-title">
                <span data-i18n="category_summary">üìã Resumen por categor√≠as</span>
                <small style="font-size: 11px; font-weight: normal; opacity: 0.7;" data-i18n="click_to_filter">(Click para filtrar)</small>
                <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
                    <button id="cat-confirm-icon" class="icon-btn icon-confirm" title="Confirmar selecci√≥n" onclick="window.applyPendingSelection()" aria-label="Confirmar selecci√≥n">‚úì</button>
                    <button id="cat-cancel-icon" class="icon-btn icon-cancel" title="Cancelar selecci√≥n" onclick="window.clearPendingSelection()" aria-label="Cancelar selecci√≥n">
                        <svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg>
                    </button>
                </div>
            </h3>
            <div id="category-summary-table"></div>
        </div>

        <div class="db-container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="db-container-title" style="margin-bottom: 0;">
                    <span data-i18n="all_transactions">üí≥ Todas las transacciones</span>
                    <span id="toggle-secret-col" title="Mostrar/Ocultar pagador" style="cursor: pointer; opacity: 0.6; margin-left: 10px; font-size: 16px;">üîí</span>
                    <div style="margin-left:auto; display:flex; gap:6px; align-items:center;">
                        <button id="all-confirm-icon" class="icon-btn icon-confirm" title="Confirmar selecci√≥n" onclick="window.applyPendingSelection()" aria-label="Confirmar selecci√≥n">‚úì</button>
                        <button id="all-cancel-icon" class="icon-btn icon-cancel" title="Cancelar selecci√≥n" onclick="window.clearPendingSelection()" aria-label="Cancelar selecci√≥n">
                            <svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg>
                        </button>
                    </div>
                </h3>
                <button class="action-btn" style="margin: 0;" onclick="window.exportToCSV()" data-i18n="export_csv">
                    üìä Exportar CSV
                </button>
            </div>
            
            <div class="actions-bar">
                <div class="search-box">
                    <input type="text" id="transaction-search" data-i18n="search_by_concept" placeholder="Buscar por concepto...">
                </div>
            </div>
            
            <div id="all-transactions-table" style="max-height: 640px; overflow-y: auto;"></div>
        </div>

        <div id="loading" data-i18n="loading_data">Cargando datos financieros... ‚è≥</div>
        <div id="error"></div>
        
        <!-- Botones flotantes (FAB) -->
        <button id="clear-filters-fab" class="fab" title="" onclick="window.clearAllFilters()" data-i18n="clear_all_title">
            <span class="fab-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" focusable="false" aria-hidden="true">
                    <path d="M3 5h18v2l-7 7v5l-4 2v-7L3 7V5z" />
                </svg>
            </span>
            <span class="fab-x" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="14" height="14" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg>
            </span>
        </button>
        
        <!-- FAB Confirmar selecci√≥n -->
        <button id="fab-confirm" class="fab fab-confirm" title="Confirmar selecci√≥n" onclick="window.applyPendingSelection()" aria-label="Confirmar selecci√≥n" style="display: none;">
            ‚úì
        </button>
        
        <!-- FAB Cancelar selecci√≥n -->
        <button id="fab-cancel" class="fab fab-cancel" title="Cancelar selecci√≥n" onclick="window.clearPendingSelection()" aria-label="Cancelar selecci√≥n" style="display: none;">
            <svg viewBox="0 0 24 24" width="20" height="20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function() {
            'use strict';
            
            // ============================================================================
            // CONFIGURACI√ìN GLOBAL DE LA APLICACI√ìN
            // ============================================================================
            
            /**
             * Configuraci√≥n centralizada de la aplicaci√≥n
             * Todos los valores configurables est√°n aqu√≠ para f√°cil mantenimiento
             */
            const APP_CONFIG = {
                // Data source
                DATA_URL: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbRz_jPWvTjSM4jmrlUdShW9JzuNagS1LaSQ43rUupeA4e6XbdEqg-UupxL7mn5lNwGftn_8FDPikX/pub?gid=1981585980&single=true&output=tsv',
                
                // Business constants
                TOTAL_HOMES: 160,
                
                // UI constants
                DEFAULT_ITEMS_PER_PAGE: 50,
                DEFAULT_SORT_COLUMN: 'F. Operativa',
                DEFAULT_SORT_DIRECTION: 'desc',
                DEFAULT_FILTER: 'current_year',
                
                // Performance
                SEARCH_DEBOUNCE_DELAY: 300,
                
                // Chart colors
                CHART_COLORS: {
                    INCOME: '--color-ingresos',
                    EXPENSES: '--color-gastos',
                    PER_HOME: '--color-per-home',
                    BALANCE: '--color-balance',
                    SALDO_MINIMO: '--color-saldo-minimo'
                },
                
                // Date formats
                DATE_FORMAT_LOCALE: 'es-ES',
                DATE_FORMAT_OPTIONS: { day: '2-digit', month: 'long', year: 'numeric' },
                
                // Storage keys
                STORAGE_KEYS: {
                    LANGUAGE: 'dashboardLanguage'
                },
                
                // Error messages
                ERROR_MESSAGES: {
                    LOAD_FAILED: 'Error al cargar los datos',
                    NO_DATA: 'No se encontraron datos en el archivo TSV',
                    NETWORK_ERROR: 'Error de conexi√≥n. Verifica tu conexi√≥n a internet',
                    PARSE_ERROR: 'Error al procesar los datos'
                }
            };

            // Registry for chart instances created by this script (modern API usage)
            window._charts = window._charts || {};

            // ============================================================================
            // UTILIDADES GENERALES
            // ============================================================================

            /**
             * Implementaci√≥n de debounce para optimizar eventos repetitivos
             * @param {Function} fn - Funci√≥n a ejecutar
             * @param {number} delay - Delay en milisegundos
             * @returns {Function} Funci√≥n debounced
             */
            function debounce(fn, delay) {
                let timeoutId;
                return function(...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => fn.apply(this, args), delay);
                };
            }

            /**
             * Clase para manejo centralizado de errores
             */
            class AppError extends Error {
                constructor(message, type = 'GENERAL', details = null) {
                    super(message);
                    this.name = 'AppError';
                    this.type = type;
                    this.details = details;
                    this.timestamp = new Date().toISOString();
                }
            }

            const ErrorHandler = {
                log(error) {
                    const errorInfo = {
                        type: error.type || 'UNKNOWN',
                        message: error.message,
                        details: error.details,
                        timestamp: error.timestamp || new Date().toISOString(),
                        stack: error.stack
                    };
                    console.error('[AppError]', errorInfo);
                    // Aqu√≠ podr√≠as enviar a un servicio de logging como Sentry
                },
                
                showToUser(error, elementId = 'error') {
                    const errorDiv = document.getElementById(elementId);
                    if (errorDiv) {
                        errorDiv.innerHTML = `
                            <strong>Error:</strong> ${error.message}
                            ${error.details ? `<br><small>${error.details}</small>` : ''}
                        `;
                        errorDiv.style.display = 'block';
                    }
                },
                
                handle(error, showUser = true) {
                    this.log(error);
                    if (showUser) {
                        this.showToUser(error);
                    }
                }
            };

            // Utility to destroy all Chart.js charts using the modern API and our registry.
            function destroyAllCharts() {
                if (window._charts) {
                    Object.keys(window._charts).forEach(key => {
                        try {
                            const c = window._charts[key];
                            if (c && typeof c.destroy === 'function') c.destroy();
                        } catch (e) { /* ignore */ }
                    });
                    window._charts = {};
                    return;
                }

                if (typeof Chart === 'undefined') return;

                // Chart.js v3+ exposes Chart.getChart(canvas) to retrieve a chart instance by canvas
                if (typeof Chart.getChart === 'function') {
                    document.querySelectorAll('canvas').forEach(canvas => {
                        try {
                            const ch = Chart.getChart(canvas);
                            if (ch && typeof ch.destroy === 'function') ch.destroy();
                        } catch (e) { /* ignore */ }
                    });
                    return;
                }

                // Fallback for older Chart.js where Chart.instances may exist
                try {
                    if (Chart.instances && typeof Object.values === 'function') {
                        Object.values(Chart.instances).forEach(inst => { if (inst && typeof inst.destroy === 'function') inst.destroy(); });
                    }
                } catch (e) {
                    // nothing we can do
                }
            }

            // --- TRADUCCIONES ---
            const translations = {
                es: {
                    // T√≠tulos de secciones
                    'filters': 'üîç Filtros',
                    'monthly_movements': 'üìà Movimientos bancarios mensuales',
                    'click_points': '(Click en puntos para filtrar por mes)',
                    'top_movements': 'üèÜ Top Movimientos por categor√≠a',
                    'highest_moves': '(Mayores ingresos o gastos)',
                    'expenses_by_category': 'üìä Gastos por categor√≠a',
                    'click_to_filter': '(Click para filtrar)',
                    'category_summary': 'üìã Resumen por categor√≠as',
                    'all_transactions': 'üí≥ Todas las transacciones',

                    // Filtros
                    'quick_period': 'Per√≠odo r√°pido:',
                    'from_date': 'Fecha desde:',
                    'to_date': 'Fecha hasta:',
                    'all_data': 'Todos los datos',
                    'current_month': 'Mes actual',
                    'current_year': 'A√±o actual',
                    'last_3_months': '√öltimos 3 meses',
                    'last_6_months': '√öltimos 6 meses',
                    'last_12_months': '√öltimos 12 meses',

                    // Encabezados de tabla
                    'date': 'Fecha',
                    'category': 'Categor√≠a',
                    'concept': 'Concepto',
                    'amount': 'Importe',
                    'per_home': 'per Home',
                    'type': 'Tipo',
                    'income': 'Ingreso',
                    'expense': 'Gasto',
                    'count': 'Cantidad',
                    'expenses_sum': 'Suma Gastos',
                    'total_percent': '% del Total',
                    'total': 'TOTAL',
                    'balance': 'Saldo',

                    // Disclaimer
                    'important_note': 'Nota importante:',
                    'disclaimer_text': 'Los saldos bancarios no incluye las facturas pendientes (impagadas o sin registrar). El reparto de gastos \'Per Home\' es un promedio simple (total de gastos / 160) y no considera el coeficiente de participaci√≥n espec√≠fico de cada propietario.'
                ,
                'active_filters': 'Filtros activos:',
                'clear_all': '‚úï Limpiar todos',
                'clear_all_title': '‚úñÔ∏è',
                'loading_data': 'Cargando datos financieros... ‚è≥',
                'no_movements': 'No hay movimientos para mostrar.',
                'export_csv': 'üìä Exportar CSV',
                'search_by_concept': 'Buscar por concepto...',
                'last_update': '√öltima actualizaci√≥n:',
                'page': 'P√°gina',
                'of': 'de',
                'records': 'registros',
                'no_data_export': 'No hay datos para exportar',
                
                // Chart Labels (NUEVO)
                'chart_label_expenses': 'Gastos (‚Ç¨)',
                'chart_label_income': 'Ingresos',
                'chart_label_expenses_only': 'Gastos',
                'chart_label_per_home': 'per Home',
                'chart_label_min_balance': 'Saldo M√≠nimo',
                'chart_label_final_balance': 'Saldo Final',
                'chart_axis_income_expenses': 'Ingresos / Gastos (‚Ç¨)',
                'chart_axis_per_home': 'per Home (‚Ç¨)',
                'chart_axis_balance': 'Saldo (‚Ç¨)',
                'chart_tooltip_expenses': 'Gastos:',
                'chart_tooltip_final_balance': 'Saldo Final:',
                'enter_password_concept': 'Introduce la contrase√±a para ver el concepto original:'
                },
                en: {
                    // Section titles
                    'filters': 'üîç Filters',
                    'monthly_movements': 'üìà Monthly Bank Movements',
                    'click_points': '(Click on points to filter by month)',
                    'top_movements': 'üèÜ Top Movements per category',
                    'highest_moves': '(Highest income or expenses)',
                    'expenses_by_category': 'üìä Expenses by Category',
                    'click_to_filter': '(Click to filter)',
                    'category_summary': 'üìã Category Summary',
                    'all_transactions': 'üí≥ All Transactions',

                    // Filters
                    'quick_period': 'Quick period:',
                    'from_date': 'From date:',
                    'to_date': 'To date:',
                    'all_data': 'All data',
                    'current_month': 'Current month',
                    'current_year': 'Current year',
                    'last_3_months': 'Last 3 months',
                    'last_6_months': 'Last 6 months',
                    'last_12_months': 'Last 12 months',

                    // Table headers
                    'date': 'Date',
                    'category': 'Category',
                    'concept': 'Concept',
                    'amount': 'Amount',
                    'per_home': 'per Home',
                    'type': 'Type',
                    'income': 'Income',
                    'expense': 'Expense',
                    'count': 'Count',
                    'expenses_sum': 'Expenses Sum',
                    'total_percent': 'Total %',
                    'total': 'TOTAL',
                    'balance': 'Saldo',

                    // Disclaimer
                    'important_note': 'Important note:',
                    'disclaimer_text': 'Bank balances do not include pending invoices (unpaid or unregistered). The \'Per Home\' expense distribution is a simple average (total expenses / 160) and does not consider the specific participation coefficient of each owner.'
                ,
                'active_filters': 'Active filters:',
                'clear_all': '‚úï Clear all',
                'clear_all_title': '‚úñÔ∏è',
                'loading_data': 'Loading financial data... ‚è≥',
                'no_movements': 'No movements to display.',
                'export_csv': 'üìä Export CSV',
                'search_by_concept': 'Search by concept...',
                'last_update': 'Last Update:',
                'page': 'Page',
                'of': 'of',
                'records': 'records',
                'no_data_export': 'No data to export',
                
                // Chart Labels (NUEVO)
                'chart_label_expenses': 'Expenses (‚Ç¨)',
                'chart_label_income': 'Income',
                'chart_label_expenses_only': 'Expenses',
                'chart_label_per_home': 'per Home',
                'chart_label_min_balance': 'Min. Balance',
                'chart_label_final_balance': 'Final Balance',
                'chart_axis_balance': 'Balance (‚Ç¨)',
                'chart_tooltip_final_balance': 'Final Balance:',
                'chart_axis_income_expenses': 'Income / Expenses (‚Ç¨)',
                'chart_axis_per_home': 'per Home (‚Ç¨)',
                'chart_tooltip_expenses': 'Expenses:',
                'enter_password_concept': 'Enter the password to view the original concept:'
                }
            };

            // Add KPI translation keys
            translations.es.kpi_total_ingresos = 'Total Ingresos';
            translations.es.kpi_total_ingresos_note = 'Suma de ingresos';
            translations.es.kpi_total_gastos = 'Total Gastos';
            translations.es.kpi_total_gastos_note = 'Suma de gastos';
            translations.es.kpi_total_per_home = 'Total Per Home';
            translations.es.kpi_total_per_home_note = 'Gastos per home';
            translations.es.kpi_balance_actual = 'Balance Actual';
            translations.es.kpi_balance_actual_note = 'Saldo m√°s reciente (global)';
            translations.es.kpi_transacciones = 'Transacciones';
            translations.es.kpi_transacciones_note = 'Registros procesados';
            translations.es.label_language = 'üåê Idioma:';

            translations.en.kpi_total_ingresos = 'Total Income';
            translations.en.kpi_total_ingresos_note = 'Sum of income';
            translations.en.kpi_total_gastos = 'Total Expenses';
            translations.en.kpi_total_gastos_note = 'Sum of expenses';
            translations.en.kpi_total_per_home = 'Total Per Home';
            translations.en.kpi_total_per_home_note = 'Per-home expenses';
            translations.en.kpi_balance_actual = 'Current Balance';
            translations.en.kpi_balance_actual_note = 'Most recent balance (global)';
            translations.en.kpi_transacciones = 'Transactions';
            translations.en.kpi_transacciones_note = 'Processed records';
            translations.en.label_language = 'üåê Language:';

            // Title
            translations.es.dashboard_title = 'Movimientos Bancarios';
            translations.en.dashboard_title = 'Bank Movements';
            translations.es.dashboard_subtitle = 'An√°lisis y seguimiento de transacciones bancarias';
            translations.en.dashboard_subtitle = 'Bank transaction analysis and tracking';

            // ============================================================================
            // GESTI√ìN DE ESTADO CENTRALIZADA
            // ============================================================================
            
            /**
             * Estado centralizado de la aplicaci√≥n
             * Toda la informaci√≥n del estado est√° en un √∫nico objeto para mejor mantenimiento
             */
            const AppState = {
                // Datos
                data: {
                    financial: [],
                    filtered: []
                },
                
                // Idioma
                language: localStorage.getItem(APP_CONFIG.STORAGE_KEYS.LANGUAGE) || 'es',
                
                // Filtros
                filters: {
                    current: APP_CONFIG.DEFAULT_FILTER,
                    categories: new Set(),
                    pendingCategories: new Set(),
                    months: new Set(),
                    pendingMonths: new Set(),
                    dateRange: {
                        start: null,
                        end: null
                    },
                    searchQuery: ''
                },
                
                // UI State
                ui: {
                    currentPage: 1,
                    itemsPerPage: APP_CONFIG.DEFAULT_ITEMS_PER_PAGE,
                    sortColumn: APP_CONFIG.DEFAULT_SORT_COLUMN,
                    sortDirection: APP_CONFIG.DEFAULT_SORT_DIRECTION,
                    // Sort state para Top Movements
                    topMovementsSortColumn: null,
                    topMovementsSortDirection: 'asc',
                    // Sort state para Category Summary
                    categorySummarySortColumn: null,
                    categorySummarySortDirection: 'asc'
                },
                
                // Colores de los gr√°ficos (se cargan din√°micamente)
                chartColors: {},
                
                // M√©todos para actualizar el estado
                setFinancialData(data) {
                    this.data.financial = data;
                },
                
                setLanguage(lang) {
                    this.language = lang;
                    localStorage.setItem(APP_CONFIG.STORAGE_KEYS.LANGUAGE, lang);
                },
                
                updateFilter(filterType, value) {
                    this.filters.current = value;
                },
                
                addCategory(category, isPending = false) {
                    const targetSet = isPending ? this.filters.pendingCategories : this.filters.categories;
                    targetSet.add(category);
                },
                
                removeCategory(category, isPending = false) {
                    const targetSet = isPending ? this.filters.pendingCategories : this.filters.categories;
                    targetSet.delete(category);
                },
                
                toggleCategory(category, isPending = false) {
                    const targetSet = isPending ? this.filters.pendingCategories : this.filters.categories;
                    if (targetSet.has(category)) {
                        targetSet.delete(category);
                    } else {
                        targetSet.add(category);
                    }
                },
                
                clearCategories(isPending = false) {
                    const targetSet = isPending ? this.filters.pendingCategories : this.filters.categories;
                    targetSet.clear();
                },
                
                confirmPendingCategories() {
                    this.filters.categories = new Set(this.filters.pendingCategories);
                    this.filters.pendingCategories.clear();
                },
                
                addMonth(month, isPending = false) {
                    const targetSet = isPending ? this.filters.pendingMonths : this.filters.months;
                    targetSet.add(month);
                },
                
                toggleMonth(month, isPending = false) {
                    const targetSet = isPending ? this.filters.pendingMonths : this.filters.months;
                    if (targetSet.has(month)) {
                        targetSet.delete(month);
                    } else {
                        targetSet.add(month);
                    }
                },
                
                clearMonths(isPending = false) {
                    const targetSet = isPending ? this.filters.pendingMonths : this.filters.months;
                    targetSet.clear();
                },
                
                confirmPendingMonths() {
                    this.filters.months = new Set(this.filters.pendingMonths);
                    this.filters.pendingMonths.clear();
                },
                
                setDateRange(start, end) {
                    this.filters.dateRange.start = start;
                    this.filters.dateRange.end = end;
                },
                
                setSearchQuery(query) {
                    this.filters.searchQuery = query;
                },
                
                resetAllFilters() {
                    this.filters.current = APP_CONFIG.DEFAULT_FILTER;
                    this.filters.categories.clear();
                    this.filters.pendingCategories.clear();
                    this.filters.months.clear();
                    this.filters.pendingMonths.clear();
                    this.filters.dateRange.start = null;
                    this.filters.dateRange.end = null;
                    this.filters.searchQuery = '';
                    this.ui.currentPage = 1;
                },
                
                setSortColumn(column, direction = null) {
                    if (this.ui.sortColumn === column && direction === null) {
                        // Toggle direction
                        this.ui.sortDirection = this.ui.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.ui.sortColumn = column;
                        this.ui.sortDirection = direction || 'asc';
                    }
                },
                
                setPage(page) {
                    this.ui.currentPage = page;
                },
                
                loadChartColors() {
                    const styles = getComputedStyle(document.documentElement);
                    this.chartColors.ingresos = styles.getPropertyValue(APP_CONFIG.CHART_COLORS.INCOME).trim();
                    this.chartColors.gastos = styles.getPropertyValue(APP_CONFIG.CHART_COLORS.EXPENSES).trim();
                    this.chartColors.perHome = styles.getPropertyValue(APP_CONFIG.CHART_COLORS.PER_HOME).trim();
                    this.chartColors.saldoMinimo = styles.getPropertyValue(APP_CONFIG.CHART_COLORS.SALDO_MINIMO).trim();
                    this.chartColors.balance = styles.getPropertyValue(APP_CONFIG.CHART_COLORS.BALANCE).trim();
                }
            };
            
            // Aliases para compatibilidad con c√≥digo existente (se ir√°n eliminando gradualmente)
            let currentLanguage = AppState.language;
            let financialData = AppState.data.financial;
            let currentFilter = AppState.filters.current;
            let selectedCategories = AppState.filters.categories;
            let pendingSelectedCategories = AppState.filters.pendingCategories;
            let selectedMonths = AppState.filters.months;
            let pendingSelectedMonths = AppState.filters.pendingMonths;
            let startDate = AppState.filters.dateRange.start;
            let endDate = AppState.filters.dateRange.end;
            let searchQuery = AppState.filters.searchQuery;
            let currentPage = AppState.ui.currentPage;
            let itemsPerPage = AppState.ui.itemsPerPage;
            let sortColumn = AppState.ui.sortColumn;
            let sortDirection = AppState.ui.sortDirection;
            let topMovementsSortColumn = AppState.ui.topMovementsSortColumn;
            let topMovementsSortDirection = AppState.ui.topMovementsSortDirection;
            let categorySummarySortColumn = AppState.ui.categorySummarySortColumn;
            let categorySummarySortDirection = AppState.ui.categorySummarySortDirection;
            const chartColors = AppState.chartColors;

            // ============================================================================
            // FUNCIONES AUXILIARES Y DE PARSEO
            // ============================================================================
            
            /**
             * Convierte un color hexadecimal a formato RGBA
             * @param {string} hex - Color en formato hexadecimal (#RRGGBB)
             * @param {number} alpha - Valor de transparencia (0-1)
             * @returns {string} Color en formato rgba()
             */
            function hexToRgba(hex, alpha = 1) {
                const bigint = parseInt(hex.slice(1), 16);
                const r = (bigint >> 16) & 255;
                const g = (bigint >> 8) & 255;
                const b = bigint & 255;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            /**
             * Parsea texto en formato TSV y lo convierte en array de objetos
             * @param {string} tsvText - Texto en formato TSV
             * @returns {Array<Object>} Array de objetos con los datos
             */
            function parseTSV(tsvText) {
                const lines = tsvText.split('\n');
                const headers = lines[0].split('\t');
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split('\t');
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index] ? values[index].trim() : '';
                        });
                        data.push(row);
                    }
                }
                return data;
            }
            
            function parseAmount(amountStr) {
                if (!amountStr || amountStr === '') return 0;
                let cleanStr = amountStr.replace(/‚Ç¨/g, '').replace(/"/g, '').trim();
                if (!cleanStr) return 0;
                if (cleanStr.includes('.') && cleanStr.includes(',')) {
                    cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
                } else if (cleanStr.includes(',') && !cleanStr.includes('.')) {
                    cleanStr = cleanStr.replace(',', '.');
                }
                const result = parseFloat(cleanStr);
                return isNaN(result) ? 0 : result;
            }
            
            // ============================================================================
            // SISTEMA DE FORMATEO DE N√öMEROS - CONFIGURACI√ìN CENTRALIZADA
            // ============================================================================
            // Este m√≥dulo proporciona formateo consistente de n√∫meros en toda la aplicaci√≥n.
            // Para cambiar el formato, modifica solo la configuraci√≥n aqu√≠.
            // ============================================================================
            
            const NUMBER_FORMAT_CONFIG = {
                locale: 'es-ES',
                currency: 'EUR',
                defaults: {
                    number: {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                        useGrouping: true
                    },
                    currency: {
                        style: 'currency',
                        currency: 'EUR',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                        useGrouping: true
                    },
                    percent: {
                        style: 'percent',
                        minimumFractionDigits: 1,
                        maximumFractionDigits: 1
                    }
                }
            };

            // Cache de formateadores para optimizar rendimiento
            const formatters = {
                number: new Intl.NumberFormat(NUMBER_FORMAT_CONFIG.locale, NUMBER_FORMAT_CONFIG.defaults.number),
                currency: new Intl.NumberFormat(NUMBER_FORMAT_CONFIG.locale, NUMBER_FORMAT_CONFIG.defaults.currency),
                percent: new Intl.NumberFormat(NUMBER_FORMAT_CONFIG.locale, NUMBER_FORMAT_CONFIG.defaults.percent)
            };

            /**
             * Formatea un n√∫mero con el estilo espa√±ol (punto para miles, coma para decimales)
             * @param {number} value - El n√∫mero a formatear
             * @param {number|null} minimumFractionDigits - N√∫mero m√≠nimo de decimales (null = usar default)
             * @param {number|null} maximumFractionDigits - N√∫mero m√°ximo de decimales (null = usar default)
             * @returns {string} - N√∫mero formateado como string
             * @example formatNumber(1234.56) => "1.234,56"
             * @example formatNumber(1234.56, 0, 0) => "1.235"
             */
            function formatNumber(value, minimumFractionDigits = null, maximumFractionDigits = null) {
                if (value === null || value === undefined || isNaN(value)) return '';
                
                // Si se especifican d√≠gitos personalizados, crear un nuevo formateador
                if (minimumFractionDigits !== null || maximumFractionDigits !== null) {
                    const options = {
                        ...NUMBER_FORMAT_CONFIG.defaults.number,
                        useGrouping: true
                    };
                    if (minimumFractionDigits !== null) options.minimumFractionDigits = minimumFractionDigits;
                    if (maximumFractionDigits !== null) options.maximumFractionDigits = maximumFractionDigits;
                    return new Intl.NumberFormat(NUMBER_FORMAT_CONFIG.locale, options).format(value);
                }

                // Usar el formateador cacheado para mejor rendimiento
                return formatters.number.format(value);
            }

            /**
             * Formatea un n√∫mero como moneda en euros con el formato espa√±ol
             * @param {number} amount - La cantidad a formatear
             * @returns {string} - Cantidad formateada con s√≠mbolo de euro
             * @example formatCurrency(1234.56) => "1.234,56 ‚Ç¨"
             */
            function formatCurrency(amount) {
                if (amount === null || amount === undefined || isNaN(amount)) {
                    return formatters.currency.format(0);
                }
                return formatters.currency.format(amount);
            }

            /**
             * Formatea un n√∫mero como porcentaje
             * @param {number} value - El valor a formatear (0.15 = 15%)
             * @returns {string} - Valor formateado como porcentaje
             * @example formatPercent(0.1523) => "15,2%"
             */
            function formatPercent(value) {
                if (value === null || value === undefined || isNaN(value)) return '0,0%';
                return formatters.percent.format(value);
            }

            // ============================================================================
            // FIN DEL SISTEMA DE FORMATEO
            // ============================================================================
            
            function parseDate(dateStr) {
                if (!dateStr) return null;
                let date;
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/'); // Asume DD/MM/YYYY
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                    date = new Date(dateStr); // Intenta parseo est√°ndar
                }
                return !isNaN(date.getTime()) ? date : null;
            }

            // --- L√ìGICA DE FILTRADO Y C√ÅLCULO ---

            function getFilteredData() {
                let data = financialData;
                const isDateRangeActive = startDate || endDate;

                document.getElementById('filter-select').disabled = isDateRangeActive;

                if (isDateRangeActive) {
                    data = data.filter(item => {
                        const itemDate = parseDate(item['F. Operativa']);
                        if (!itemDate) return false;
                        const startCheck = !startDate || itemDate >= startDate;
                        const endCheck = !endDate || itemDate <= endDate;
                        return startCheck && endCheck;
                    });
                } else if (currentFilter !== 'all') {
                    const currentDate = new Date();
                    data = data.filter(item => {
                        const itemDate = parseDate(item['F. Operativa']);
                        if (!itemDate) return false;
                        
                        switch (currentFilter) {
                            case 'current_month':
                                return itemDate.getFullYear() === currentDate.getFullYear() && itemDate.getMonth() === currentDate.getMonth();
                            case 'current_year':
                                return itemDate.getFullYear() === currentDate.getFullYear();
                            case 'last_3_months': {
                                const targetDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 2, 1);
                                return itemDate >= targetDate;
                            }
                            case 'last_6_months': {
                                const targetDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 5, 1);
                                return itemDate >= targetDate;
                            }
                            case 'last_12_months': {
                                const targetDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 11, 1);
                                return itemDate >= targetDate;
                            }
                            default: return true;
                        }
                    });
                }
                
                if (selectedCategories.size > 0) {
                    data = data.filter(item => {
                        const category = item.Categoria || 'Sin categor√≠a';
                        return selectedCategories.has(category);
                    });
                }
                
                if (selectedMonths.size > 0) {
                    data = data.filter(item => {
                        const itemDate = parseDate(item['F. Operativa']);
                        if (!itemDate || isNaN(itemDate.getTime())) return false;
                        const itemMonthKey = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
                        return selectedMonths.has(itemMonthKey);
                    });
                }
                return data;
            }

            function calculateSummary(data) {
                const summary = { totalIngresos: 0, totalGastos: 0, totalPerHome: 0, saldoFinal: 0, transacciones: data.length };
                
                data.forEach(item => {
                    summary.totalGastos += parseAmount(item.Gastos || '0');
                    summary.totalIngresos += parseAmount(item.Ingresos || '0');
                    summary.totalPerHome += parseAmount(item['per Home'] || '0');
                });
                
                if (financialData.length > 0) {
                    summary.saldoFinal = parseAmount(financialData[0]['Saldo'] || '0');
                }
                
                return summary;
            }
            
            function getExpensesByCategory(data) {
                const categories = {};
                
                data.forEach((item) => {
                    const gastos = parseAmount(item.Gastos || '0');
                    if (gastos > 0) {
                        const category = item.Categoria || 'Sin categor√≠a';
                        categories[category] = (categories[category] || 0) + gastos;
                    }
                });
                
                return Object.entries(categories).sort(([,a], [,b]) => b - a).slice(0, 10);
            }
            
            function getMonthlyFlow(data) {
                const monthlyData = {};
                
                data.forEach(item => {
                    const date = parseDate(item['F. Operativa']);
                    if (!date) return;
                    
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            ingresos: 0,
                            gastos: 0,
                            perHome: 0,
                            balances: []
                        };
                    }
                    
                    monthlyData[monthKey].gastos += parseAmount(item.Gastos || '0');
                    monthlyData[monthKey].ingresos += parseAmount(item.Ingresos || '0');
                    monthlyData[monthKey].perHome += parseAmount(item['per Home'] || '0');
                    // Guardamos el saldo junto con la fecha para poder elegir el saldo del d√≠a m√°s reciente del mes
                    monthlyData[monthKey].balances.push({ date: date.getTime(), balance: parseAmount(item['Saldo'] || '0') });
                });
                
                Object.keys(monthlyData).forEach(key => {
                    if (monthlyData[key].balances.length > 0) {
                        const balancesArr = monthlyData[key].balances;
                        // minBalance: m√≠nimo entre los valores de balance
                        monthlyData[key].minBalance = Math.min(...balancesArr.map(b => b.balance));
                        // finalBalance: saldo correspondiente a la fecha m√°s reciente del mes
                        balancesArr.sort((a, b) => a.date - b.date);
                        monthlyData[key].finalBalance = balancesArr[balancesArr.length - 1].balance;
                    } else {
                        monthlyData[key].minBalance = 0;
                        monthlyData[key].finalBalance = 0;
                    }
                    delete monthlyData[key].balances;
                });
                
                return Object.entries(monthlyData).sort(([a], [b]) => a.localeCompare(b));
            }

            function getTopMovements(data) {
                // Primero, encontramos las 5 categor√≠as con mayor suma de movimientos
                const categoryTotals = {};
                data.forEach(item => {
                    const category = item.Categoria || 'Sin categor√≠a';
                    const ingresos = parseAmount(item.Ingresos || '0');
                    const gastos = parseAmount(item.Gastos || '0');
                    const absoluteValue = Math.abs(ingresos > 0 ? ingresos : -gastos);
                    
                    if (!categoryTotals[category]) {
                        categoryTotals[category] = { total: 0, movements: [] };
                    }
                    categoryTotals[category].total += absoluteValue;
                    categoryTotals[category].movements.push({
                        ...item,
                        amount: ingresos > 0 ? ingresos : -gastos,
                        absoluteValue
                    });
                });

                // Ordenamos las categor√≠as por el total y tomamos las top 5
                const top5Categories = Object.entries(categoryTotals)
                    .sort(([,a], [,b]) => b.total - a.total)
                    .slice(0, 5);

                // Para cada categor√≠a top, encontramos su movimiento m√°s alto
                const topMovements = top5Categories.map(([category, data]) => {
                    const topMovement = data.movements.sort((a, b) => b.absoluteValue - a.absoluteValue)[0];
                    return topMovement;
                });

                // Ordenamos los movimientos seleccionados por valor absoluto
                topMovements.sort((a, b) => b.absoluteValue - a.absoluteValue);

                return topMovements;
            }

            // --- FUNCIONES DE GR√ÅFICOS Y TABLAS ---
            function createBarChart(canvasId, data) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;

                // Destroy any existing chart for this canvas (modern API)
                try { if (window._charts && window._charts[canvasId]) window._charts[canvasId].destroy(); } catch (e) { /* ignore */ }

                const ctx = canvas.getContext('2d');
                const chart = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: data.map(([label]) => label.length > 15 ? label.substring(0, 15) + '...' : label),
                        datasets: [{
                            label: translate('chart_label_expenses'), // <-- MODIFICADO
                            data: data.map(([, value]) => value),
                            backgroundColor: data.map(([label]) => 
                                selectedCategories.has(label) ? hexToRgba(chartColors.balance, 0.8) : (pendingSelectedCategories.has(label) ? 'rgba(255, 193, 7, 0.9)' : 'rgba(52, 73, 94, 0.8)')
                            ),
                            borderColor: data.map(([label]) => 
                                selectedCategories.has(label) ? chartColors.balance : (pendingSelectedCategories.has(label) ? 'rgba(255, 193, 7, 1)' : 'rgba(52, 73, 94, 1)')
                            ),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const category = data[index][0];
                                // stage pending selection (user must confirm)
                                window.selectPendingCategory(event, category);
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: context => data[context[0].dataIndex][0],
                                    label: context => `${translate('chart_tooltip_expenses')} ${formatCurrency(data[context.dataIndex][1])}` // <-- MODIFICADO
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#7f8c8d', maxRotation: 45, minRotation: 0 }
                            },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(127, 140, 141, 0.2)' },
                                ticks: {
                                    color: '#7f8c8d',
                                    callback: value => formatCurrency(value)
                                }
                            }
                        }
                    }
                });

                // Save instance to registry
                window._charts = window._charts || {};
                window._charts[canvasId] = chart;
            }

            function createLineChart(canvasId, data) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                const last12MonthsData = data.slice(-12);

                // Destroy any existing chart for this canvas (modern API)
                try { if (window._charts && window._charts[canvasId]) window._charts[canvasId].destroy(); } catch (e) { /* ignore */ }

                const ctx = canvas.getContext('2d');
                const chart = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: last12MonthsData.map(([month]) => {
                            const [year, monthNum] = month.split('-');
                            return `${monthNum}/${year}`;
                        }),
                        datasets: [{
                            label: translate('chart_label_income'), // <-- MODIFICADO
                            data: last12MonthsData.map(([, values]) => values.ingresos),
                            borderColor: chartColors.ingresos,
                            backgroundColor: hexToRgba(chartColors.ingresos, 0.1),
                            tension: 0.3,
                            borderWidth: 2,
                            pointBackgroundColor: last12MonthsData.map(([month]) => selectedMonths.has(month) ? chartColors.balance : (pendingSelectedMonths.has(month) ? '#ffc107' : chartColors.ingresos)),
                            pointRadius: last12MonthsData.map(([month]) => selectedMonths.has(month) ? 6 : (pendingSelectedMonths.has(month) ? 5 : 4)),
                        }, {
                            label: translate('chart_label_expenses_only'), // <-- MODIFICADO
                            data: last12MonthsData.map(([, values]) => values.gastos),
                            borderColor: chartColors.gastos,
                            backgroundColor: hexToRgba(chartColors.gastos, 0.1),
                            tension: 0.3,
                            borderWidth: 2,
                                pointBackgroundColor: last12MonthsData.map(([month]) => selectedMonths.has(month) ? chartColors.balance : (pendingSelectedMonths.has(month) ? '#ffc107' : chartColors.gastos)),
                            pointRadius: last12MonthsData.map(([month]) => selectedMonths.has(month) ? 6 : (pendingSelectedMonths.has(month) ? 5 : 4)),
                        }, {
                            label: translate('chart_label_per_home'), // <-- MODIFICADO
                            data: last12MonthsData.map(([, values]) => values.perHome),
                            borderColor: chartColors.perHome,
                            backgroundColor: hexToRgba(chartColors.perHome, 0.1),
                            tension: 0.3,
                            borderWidth: 2,
                                pointBackgroundColor: last12MonthsData.map(([month]) => selectedMonths.has(month) ? chartColors.balance : (pendingSelectedMonths.has(month) ? '#ffc107' : chartColors.perHome)),
                            pointRadius: last12MonthsData.map(([month]) => selectedMonths.has(month) ? 6 : (pendingSelectedMonths.has(month) ? 5 : 4)),
                            yAxisID: 'y1'
                        }, {
                            label: translate('chart_label_min_balance'), // <-- MODIFICADO
                            data: last12MonthsData.map(([, values]) => values.minBalance),
                            borderColor: chartColors.saldoMinimo,
                            backgroundColor: hexToRgba(chartColors.saldoMinimo, 0.1),
                            tension: 0.3,
                            borderWidth: 2,
                            pointBackgroundColor: last12MonthsData.map(([month]) => selectedMonths.has(month) ? chartColors.balance : (pendingSelectedMonths.has(month) ? '#ffc107' : chartColors.saldoMinimo)),
                        }, {
                            label: translate('chart_label_final_balance'),
                            data: last12MonthsData.map(([, values]) => values.finalBalance),
                            borderColor: chartColors.balance,
                            backgroundColor: hexToRgba(chartColors.balance, 0.1),
                            tension: 0.3,
                            borderWidth: 2,
                            yAxisID: 'y',
                            pointBackgroundColor: last12MonthsData.map(([month]) => selectedMonths.has(month) ? chartColors.balance : (pendingSelectedMonths.has(month) ? '#ffc107' : chartColors.balance)),
                            pointRadius: last12MonthsData.map(([month]) => selectedMonths.has(month) ? 6 : (pendingSelectedMonths.has(month) ? 5 : 4)),
                            pointRadius: last12MonthsData.map(([month]) => selectedMonths.has(month) ? 6 : (pendingSelectedMonths.has(month) ? 5 : 4)),
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const index = elements[0].index;
                                const monthKey = last12MonthsData[index][0];
                                window.selectPendingMonth(event, monthKey);
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#2c3e50', font: { size: 12 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: context => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                                x: { 
                                    grid: { color: 'rgba(127, 140, 141, 0.2)' },
                                    ticks: { color: '#7f8c8d' }
                               },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    beginAtZero: true,
                                    grid: { color: 'rgba(127, 140, 141, 0.2)' },
                                    ticks: { color: '#7f8c8d', callback: value => formatCurrency(value) },
                                    title: { display: true, text: translate('chart_axis_income_expenses'), color: '#2c3e50'} // <-- MODIFICADO
                               },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    beginAtZero: true,
                                    grid: { drawOnChartArea: false },
                                    ticks: { color: chartColors.perHome, callback: value => formatCurrency(value) },
                                    title: { display: true, text: translate('chart_axis_per_home'), color: chartColors.perHome} // <-- MODIFICADO
                               }
                        }
                    }
                });

                // Save instance to registry
                window._charts = window._charts || {};
                window._charts[canvasId] = chart;
            }

            function createTopMovementsTable(data) {
                const tableContainer = document.getElementById('top-movements-table');
                
                if (!data || data.length === 0) {
                    tableContainer.innerHTML = `<p style="text-align:center; color: var(--text-secondary);">${translate('no_movements')}</p>`;
                    return;
                }

                // Aplicar ordenamiento si est√° configurado
                let sortedData = [...data];
                if (topMovementsSortColumn) {
                    sortedData.sort((a, b) => {
                        let valA, valB;
                        
                        if (topMovementsSortColumn === 'F. Operativa') {
                            valA = parseDate(a[topMovementsSortColumn])?.getTime() || 0;
                            valB = parseDate(b[topMovementsSortColumn])?.getTime() || 0;
                        } else if (topMovementsSortColumn === 'amount' || topMovementsSortColumn === 'per Home') {
                            valA = topMovementsSortColumn === 'amount' ? a.amount : parseAmount(a['per Home'] || '0');
                            valB = topMovementsSortColumn === 'amount' ? b.amount : parseAmount(b['per Home'] || '0');
                        } else {
                            valA = (a[topMovementsSortColumn] || '').toLowerCase();
                            valB = (b[topMovementsSortColumn] || '').toLowerCase();
                        }
                        
                        if (valA < valB) return topMovementsSortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return topMovementsSortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                const columns = [
                    { key: 'F. Operativa', labelKey: 'date', class: '' },
                    { key: 'Categoria', labelKey: 'category', class: '' },
                    { key: 'Concepto', labelKey: 'concept', class: '' },
                    { key: 'amount', labelKey: 'amount', class: 'text-right' },
                    { key: 'per Home', labelKey: 'per_home', class: 'text-right' }
                ];

                let tableHTML = `<div class="table-scroll-wrapper"><table class="db-table">
                        <thead>
                            <tr>`;
                
                columns.forEach(col => {
                    const sortClass = topMovementsSortColumn === col.key ? 
                        (topMovementsSortDirection === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                    tableHTML += `<th class="${sortClass} ${col.class}" onclick="window.sortTopMovementsTable('${col.key}')" data-i18n="${col.labelKey}">${translate(col.labelKey)}</th>`;
                });
                
                tableHTML += `</tr>
                        </thead>
                        <tbody>`;
                
                sortedData.forEach(item => {
                    const fecha = parseDate(item['F. Operativa']);
                    const fechaStr = fecha ? fecha.toLocaleDateString('es-ES') : 'N/A';
                    const amount = item.amount;
                    const perHome = parseAmount(item['per Home'] || '0');
                    const amountClass = amount >= 0 ? 'color-ingresos' : 'color-gastos';
                    const isPending = pendingSelectedCategories.has(item.Categoria || 'Sin categor√≠a');
                    const pendingClass = isPending ? 'pending-selected' : '';
                    
                    tableHTML += `<tr class="${pendingClass}" onclick="window.selectPendingCategory(event, '${(item.Categoria||'Sin categor√≠a').replace(/'/g, "\\'")}')">
                        <td class="color-secondary">${fechaStr}</td>
                        <td class="color-secondary">${item.Categoria || 'Sin categor√≠a'}</td>
                        <td>${item.Concepto || ''}</td>
                        <td class="text-right ${amountClass}" style="font-weight: 500;">${formatCurrency(amount)}</td>
                        <td class="text-right color-per-home" style="font-weight: 500;">${formatCurrency(perHome)}</td>
                    </tr>`;
                });
                
                tableHTML += '</tbody></table></div>';
                tableContainer.innerHTML = tableHTML;
            }

             function createCategorySummaryTable(data) {
                const tableContainer = document.getElementById('category-summary-table');
                const categoryStats = {};
                
                data.forEach(item => {
                    const category = item.Categoria || 'Sin categor√≠a';
                    const gastos = parseAmount(item.Gastos || '0');
                    const perHome = parseAmount(item['per Home'] || '0');
                    
                    if (!categoryStats[category]) {
                        categoryStats[category] = { count: 0, total: 0, totalPerHome: 0 };
                    }
                    
                    categoryStats[category].count++;
                    if (gastos > 0) {
                        categoryStats[category].total += gastos;
                        categoryStats[category].totalPerHome += perHome;
                    }
                });
                
                let sortedCategories = Object.entries(categoryStats);
                
                // Aplicar ordenamiento personalizado si est√° configurado
                if (categorySummarySortColumn) {
                    sortedCategories.sort(([catA, statsA], [catB, statsB]) => {
                        let valA, valB;
                        
                        if (categorySummarySortColumn === 'category') {
                            valA = catA.toLowerCase();
                            valB = catB.toLowerCase();
                        } else if (categorySummarySortColumn === 'count') {
                            valA = statsA.count;
                            valB = statsB.count;
                        } else if (categorySummarySortColumn === 'total') {
                            valA = statsA.total;
                            valB = statsB.total;
                        } else if (categorySummarySortColumn === 'totalPerHome') {
                            valA = statsA.totalPerHome;
                            valB = statsB.totalPerHome;
                        } else if (categorySummarySortColumn === 'percentage') {
                            const totalGastos = sortedCategories.reduce((sum, [, stats]) => sum + stats.total, 0);
                            valA = totalGastos > 0 ? ((statsA.total / totalGastos) * 100) : 0;
                            valB = totalGastos > 0 ? ((statsB.total / totalGastos) * 100) : 0;
                        }
                        
                        if (valA < valB) return categorySummarySortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return categorySummarySortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                } else {
                    // Ordenamiento por defecto: por total descendente
                    sortedCategories.sort(([, a], [, b]) => b.total - a.total);
                }
                
                const totalGastos = sortedCategories.reduce((sum, [, stats]) => sum + stats.total, 0);
                const totalTransactions = sortedCategories.reduce((sum, [, stats]) => sum + stats.count, 0);
                const totalPerHomeGeneral = sortedCategories.reduce((sum, [, stats]) => sum + stats.totalPerHome, 0);

                const columns = [
                    { key: 'category', labelKey: 'category', class: '' },
                    { key: 'count', labelKey: 'count', class: 'text-center' },
                    { key: 'total', labelKey: 'expenses_sum', class: 'text-right' },
                    { key: 'totalPerHome', labelKey: 'per_home', class: 'text-right' },
                    { key: 'percentage', labelKey: 'total_percent', class: 'text-right' }
                ];

                let tableHTML = `<div class="table-scroll-wrapper"><table class="db-table"><thead><tr>`;
                
                columns.forEach(col => {
                    const sortClass = categorySummarySortColumn === col.key ? 
                        (categorySummarySortDirection === 'asc' ? 'sort-asc' : 'sort-desc') : '';
                    tableHTML += `<th class="${sortClass} ${col.class}" onclick="window.sortCategorySummaryTable('${col.key}')" data-i18n="${col.labelKey}">${translate(col.labelKey)}</th>`;
                });
                
                tableHTML += `</tr></thead><tbody>`;
                
                sortedCategories.forEach(([category, stats]) => {
                    const percentageValue = totalGastos > 0 ? ((stats.total / totalGastos) * 100) : 0;
                    const percentage = formatNumber(percentageValue, 1, 1);
                    const isSelected = selectedCategories.has(category);
                    const rowClass = 'interactive-row' + (isSelected ? ' selected' : '');
                    const isPending = pendingSelectedCategories.has(category);
                    const pendingClass = isPending ? 'pending-selected' : '';
                    tableHTML += `<tr class="${rowClass} ${pendingClass}" onclick="window.selectPendingCategory(event, '${category.replace(/'/g, "\\'")}')">
                            <td style="font-weight: 500;">${category}</td>
                            <td class="text-center">${formatNumber(stats.count, 0, 0)}</td>
                            <td class="text-right color-gastos" style="font-weight: 500;">${formatCurrency(stats.total)}</td>
                            <td class="text-right color-per-home" style="font-weight: 500;">${formatCurrency(stats.totalPerHome)}</td>
                            <td class="text-right color-secondary">${percentage}%</td>
                    </tr>`;
                });
                
                tableHTML += `</tbody><tfoot>
                        <tr>
                            <td>${translate('total')}</td>
                            <td class="text-center">${formatNumber(totalTransactions, 0, 0)}</td>
                            <td class="text-right">${formatCurrency(totalGastos)}</td>
                            <td class="text-right">${formatCurrency(totalPerHomeGeneral)}</td>
                            <td class="text-right">${formatNumber(100, 1, 1)}%</td>
                        </tr>
                </tfoot></table></div>`;
                tableContainer.innerHTML = tableHTML;
            }

            function createAllTransactionsTable(data) {
                const tableContainer = document.getElementById('all-transactions-table');
                
                let filteredData = data;
                if (searchQuery) {
                    // Buscar solo en la columna visible seg√∫n el estado del toggle
                    // secretColVisible = true -> buscar en "Concepto (Original)"
                    // secretColVisible = false -> buscar en "Concepto"
                    filteredData = data.filter(item => {
                        if (secretColVisible) {
                            // Si la columna secreta est√° visible, buscar solo en "Concepto (Original)"
                            return (item['Concepto (Original)'] || '').toLowerCase().includes(searchQuery.toLowerCase());
                        } else {
                            // Si la columna secreta est√° oculta, buscar solo en "Concepto"
                            return (item.Concepto || '').toLowerCase().includes(searchQuery.toLowerCase());
                        }
                    });
                }

                if (sortColumn) {
                    filteredData.sort((a, b) => {
                        let valA, valB;
                        
                        if (sortColumn === 'F. Operativa') {
                            valA = parseDate(a[sortColumn])?.getTime() || 0;
                            valB = parseDate(b[sortColumn])?.getTime() || 0;
                        } else if (['Gastos', 'Ingresos', 'per Home'].includes(sortColumn)) {
                            valA = parseAmount(a[sortColumn]);
                            valB = parseAmount(b[sortColumn]);
                        } else {
                            valA = (a[sortColumn] || '').toLowerCase();
                            valB = (b[sortColumn] || '').toLowerCase();
                        }
                        
                        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                
                // For All Transactions we show a scrollable list (no pagination).
                // Default visible area approximates ~20 rows; the container handles scrolling.
                const pageData = filteredData; // render all filtered rows; container will scroll

                let tableHTML = '<div class="table-scroll-wrapper"><table class="db-table compact"><thead><tr>';
                
                // --- INICIO DE MODIFICACI√ìN 2 ---
                const columns = [
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† { key: 'Tipo', labelKey: 'type', sortable: true },
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† { key: 'F. Operativa', labelKey: 'date', sortable: true },
                                    // Se reemplaza 'Concepto' por las dos versiones
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† { key: 'Concepto (Original)', labelKey: 'concept', sortable: true, cssClass: 'col-concepto-original' }, // Visible por defecto
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† { key: 'Concepto', labelKey: 'concept', sortable: true, cssClass: 'col-secreta' }, // Oculta por defecto
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† { key: 'Categoria', labelKey: 'category', sortable: true },
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† { key: 'Gastos', labelKey: 'expense', sortable: true, align: 'right' },
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† { key: 'Ingresos', labelKey: 'income', sortable: true, align: 'right' },
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† { key: 'per Home', labelKey: 'per_home', sortable: true, align: 'right' },
                                    // Se elimina la clase 'col-secreta' de 'Saldo'
                                    { key: 'Saldo', labelKey: 'balance', sortable: true, align: 'right' }
                ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ];
                // --- FIN DE MODIFICACI√ìN 2 ---
                
                columns.forEach(col => {
                    const sortClass = sortColumn === col.key ? 
                        (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : 
                        (col.sortable ? 'sortable' : '');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const alignClass = col.align ? `text-${col.align}` : '';
                    const secretClass = col.cssClass || ''; // <-- A√ëADIR ESTA L√çNEA
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† tableHTML += `<th class="${sortClass} ${alignClass} ${secretClass}" onclick="window.sortTable('${col.key}')" data-i18n="${col.labelKey}">${translate(col.labelKey)}</th>`; // <-- ${secretClass} A√ëADIDO
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† });
                
                tableHTML += '</tr></thead><tbody>';
                
                pageData.forEach(item => {
                    const fecha = parseDate(item['F. Operativa']);
                    const fechaStr = fecha ? fecha.toLocaleDateString('es-ES') : 'N/A';
                    const category = item.Categoria || '';
                    const isPending = pendingSelectedCategories.has(category);
                    const isSelected = selectedCategories.has(category);
                    const rowClass = 'interactive-row' + (isSelected ? ' selected' : '') + (isPending ? ' pending-selected' : '');

                    tableHTML += `<tr class="${rowClass}" onclick="window.selectPendingCategory(event, '${(category).replace(/'/g, "\\'")}')">`;
                    tableHTML += `<td>${item.Tipo || ''}</td>`;
                    tableHTML += `<td>${fechaStr}</td>`;
                    
                    // --- INICIO DE MODIFICACI√ìN 3A ---
                    // Ambas columnas de concepto deben tener el mismo estilo de celda
                    tableHTML += `<td class="col-concepto-original">${item['Concepto (Original)'] || ''}</td>`;
                    tableHTML += `<td class="col-secreta">${item.Concepto || ''}</td>`;
                    // --- FIN DE MODIFICACI√ìN 3A ---
                    
                    tableHTML += `<td>${category}</td>`;
                    tableHTML += `<td class="text-right color-gastos">${formatCurrency(parseAmount(item.Gastos))}</td>`;
                    tableHTML += `<td class="text-right color-ingresos">${formatCurrency(parseAmount(item.Ingresos))}</td>`;
                    tableHTML += `<td class="text-right color-per-home">${formatCurrency(parseAmount(item['per Home']))}</td>`;
                    
                    // --- INICIO DE MODIFICACI√ìN 3B ---
                    tableHTML += `<td class="text-right">${formatCurrency(parseAmount(item.Saldo))}</td>`;
                    // --- FIN DE MODIFICACI√ìN 3B ---
                    
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</tbody></table></div>';
                tableContainer.innerHTML = tableHTML;
            }            // --- Pending selection flow ---
            window.selectPendingCategory = function(event, category) {
                // toggle pending selection
                if (pendingSelectedCategories.has(category)) {
                    pendingSelectedCategories.delete(category);
                } else {
                    pendingSelectedCategories.add(category);
                }
                updatePendingSelectionUI();
            };

            // stage month selection (used by monthly chart points)
            window.selectPendingMonth = function(event, monthKey) {
                if (pendingSelectedMonths.has(monthKey)) {
                    pendingSelectedMonths.delete(monthKey);
                } else {
                    pendingSelectedMonths.add(monthKey);
                }
                updatePendingSelectionUI();
            };

            // Expose applyPendingSelection so header buttons (which call window.applyPendingSelection)
            // can trigger the action from inline onclick attributes.
            window.applyPendingSelection = function() {
                // apply pending categories and months
                let applied = false;
                if (pendingSelectedCategories.size > 0) {
                    selectedCategories = new Set([...pendingSelectedCategories]);
                    pendingSelectedCategories.clear();
                    applied = true;
                }
                if (pendingSelectedMonths.size > 0) {
                    selectedMonths = new Set([...pendingSelectedMonths]);
                    pendingSelectedMonths.clear();
                    applied = true;
                }
                if (applied) updateCharts();
                updatePendingSelectionUI();
            };

            // Expose clearPendingSelection so header buttons can call it.
            // This function will clear staged (pending) selections and also
            // deselect any applied category filters (selectedCategories), then refresh the dashboard.
            window.clearPendingSelection = function() {
                // clear staged selections (pending) and also clear applied selections
                pendingSelectedCategories.clear();
                pendingSelectedMonths.clear();
                // Clear applied selections too
                selectedCategories.clear();
                selectedMonths.clear();
                updateCharts();
                updatePendingSelectionUI();
            };

            function updatePendingSelectionUI() {
                // re-render tables so pending selections get highlighted and per-table confirm buttons appear
                // we re-run updateCharts to regenerate tables ‚Äî but avoid applying pending as filters
                const filteredData = getFilteredData();
                // Destroy any existing charts in a Chart.js-version-safe way
                destroyAllCharts();

                const expensesByCategory = getExpensesByCategory(filteredData);
                if (expensesByCategory.length > 0) createBarChart('expenses-chart', expensesByCategory);

                const topMovements = getTopMovements(filteredData);
                createTopMovementsTable(topMovements);

                const monthlyFlow = getMonthlyFlow(filteredData);
                if (monthlyFlow.length > 0) createLineChart('monthly-flow-chart', monthlyFlow);

                createCategorySummaryTable(filteredData);
                currentPage = 1;
                createAllTransactionsTable(filteredData);

                // per-section confirm buttons
                const topConfirm = document.getElementById('top-confirm-icon');
                const catConfirm = document.getElementById('cat-confirm-icon');
                const monthlyConfirm = document.getElementById('monthly-confirm-icon');
                const expensesConfirm = document.getElementById('expenses-confirm-icon');
                const allConfirm = document.getElementById('all-confirm-icon');

                const hasPendingCategory = pendingSelectedCategories.size > 0;
                const hasPendingMonth = pendingSelectedMonths.size > 0;
                const hasAnyPending = hasPendingCategory || hasPendingMonth;

                [topConfirm, catConfirm, monthlyConfirm, expensesConfirm, allConfirm].forEach(btn => {
                    if (!btn) return;
                    // enable confirm only if there's at least one pending (category or month)
                    btn.disabled = !hasAnyPending;
                });

                // Show or hide the header icon buttons depending on whether there are pending selections
                const topCancel = document.getElementById('top-cancel-icon');
                const catCancel = document.getElementById('cat-cancel-icon');
                const monthlyCancel = document.getElementById('monthly-cancel-icon');
                const expensesCancel = document.getElementById('expenses-cancel-icon');
                const allCancel = document.getElementById('all-cancel-icon');
                const displayStyle = hasAnyPending ? 'inline-flex' : 'none';
                [topConfirm, topCancel, catConfirm, catCancel, monthlyConfirm, monthlyCancel, expensesConfirm, expensesCancel, allConfirm, allCancel].forEach(el => {
                    if (!el) return;
                    el.style.display = displayStyle;
                });
                
                // Tambi√©n mostrar/ocultar los FABs flotantes de confirmaci√≥n y cancelaci√≥n
                const fabConfirm = document.getElementById('fab-confirm');
                const fabCancel = document.getElementById('fab-cancel');
                const fabDisplayStyle = hasAnyPending ? 'flex' : 'none';
                if (fabConfirm) fabConfirm.style.display = fabDisplayStyle;
                if (fabCancel) fabCancel.style.display = fabDisplayStyle;
            }

            // Note: FAB menu removed; FAB now calls clearAllFilters (restores previous behavior)

             function updatePagination(totalPages, totalItems) {
                const paginationContainer = document.getElementById('pagination');
                
                if (totalPages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }
                
                let html = '';
                html += `<button onclick="window.changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>¬´¬´</button>`;
                html += `<button onclick="window.changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Äπ</button>`;
                html += `<span class="page-info">${translate('page')} ${currentPage} ${translate('of')} ${totalPages} (${totalItems} ${translate('records')})</span>`;
                html += `<button onclick="window.changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>‚Ä∫</button>`;
                html += `<button onclick="window.changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>¬ª¬ª</button>`;
                
                paginationContainer.innerHTML = html;
            }
            
            // --- FUNCIONES DE UI Y EVENTOS ---
            function updateActiveFiltersPanel() {
                const panel = document.getElementById('active-filters');
                const badgesContainer = document.getElementById('filter-badges');
                const hasFilters = selectedCategories.size > 0 || selectedMonths.size > 0 || startDate || endDate || (currentFilter !== 'current_year' && !(startDate || endDate));
                
                if (!hasFilters) {
                    panel.classList.remove('visible');
                    return;
                }
                
                panel.classList.add('visible');
                
                let badgesHTML = '';
                
                if (currentFilter !== 'current_year' && !startDate && !endDate) {
                    const filterMap = {
                        'current_month': 'current_month',
                        'last_3_months': 'last_3_months',
                        'last_6_months': 'last_6_months',
                        'last_12_months': 'last_12_months',
                        'all': 'all_data'
                    };
                    if (filterMap[currentFilter]) {
                        badgesHTML += `<span class="filter-badge">üìÖ ${translate(filterMap[currentFilter])}</span>`;
                    }
                }
                
                if (startDate || endDate) {
                    const start = startDate ? new Date(startDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'short' }) : '...';
                    const end = endDate ? new Date(endDate).toLocaleDateString('es-ES', { year: 'numeric', month: 'short' }) : '...';
                    badgesHTML += `<span class="filter-badge">üìÜ ${start} - ${end} <span class="remove" onclick="window.clearDateRange()"><svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg></span></span>`;
                }
                
                selectedCategories.forEach(cat => {
                    badgesHTML += `<span class="filter-badge">üè∑Ô∏è ${cat} <span class="remove" onclick="window.toggleCategory('${cat.replace(/'/g, "\\'")}')"><svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg></span></span>`;
                });
                
                selectedMonths.forEach(month => {
                    const [year, monthNum] = month.split('-');
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const monthName = monthNames[parseInt(monthNum) - 1];
                    badgesHTML += `<span class="filter-badge">üìä ${monthName} ${year} <span class="remove" onclick="window.toggleMonth('${month}')"><svg viewBox="0 0 24 24" width="12" height="12" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path fill="currentColor" d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0 0-1.4z"/></svg></span></span>`;
                });
                
                badgesContainer.innerHTML = badgesHTML;
            }

             function updateCharts() {
                const filteredData = getFilteredData();
                const summary = calculateSummary(filteredData);
                
                document.getElementById('total-ingresos').textContent = formatCurrency(summary.totalIngresos);
                document.getElementById('total-gastos').textContent = formatCurrency(summary.totalGastos);
                document.getElementById('total-per-home').textContent = formatCurrency(summary.totalPerHome);
                document.getElementById('saldo-final').textContent = formatCurrency(summary.saldoFinal);
                document.getElementById('total-transacciones').textContent = formatNumber(summary.transacciones, 0, 0);

                if (financialData.length > 0) {
                    const lastUpdateDate = parseDate(financialData[0]['F. Operativa']);
                    if (lastUpdateDate) {
                        const formattedDate = lastUpdateDate.toLocaleDateString(currentLanguage === 'en' ? 'en-GB' : 'es-ES', { day: '2-digit', month: 'long', year: 'numeric' });
                        document.getElementById('last-update-date').textContent = `${translate('last_update')} ${formattedDate}`;
                    }
                }

                updateActiveFiltersPanel();
                // Destroy any existing charts in a Chart.js-version-safe way
                destroyAllCharts();
                
                const expensesByCategory = getExpensesByCategory(filteredData);
                if (expensesByCategory.length > 0) {
                    createBarChart('expenses-chart', expensesByCategory);
                }

                const topMovements = getTopMovements(filteredData);
                createTopMovementsTable(topMovements);

                const monthlyFlow = getMonthlyFlow(filteredData);
                 if (monthlyFlow.length > 0) {
                    createLineChart('monthly-flow-chart', monthlyFlow);
                }

                createCategorySummaryTable(filteredData);
                currentPage = 1;
                createAllTransactionsTable(filteredData);
                // Keep pending selection UI in sync (show/hide header icons)
                updatePendingSelectionUI();
            }

            // --- INICIALIZACI√ìN ---
            /**
             * Carga los datos financieros desde Google Sheets
             * @async
             * @throws {AppError} Si hay error al cargar o parsear los datos
             */
            async function loadData() {
                try {
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('error').style.display = 'none';
                    
                    // Cargar colores de los gr√°ficos desde CSS
                    AppState.loadChartColors();
                    
                    console.log('Intentando cargar datos desde:', APP_CONFIG.DATA_URL);
                    const response = await fetch(APP_CONFIG.DATA_URL);
                    
                    if (!response.ok) {
                        throw new AppError(
                            `${APP_CONFIG.ERROR_MESSAGES.NETWORK_ERROR}: HTTP ${response.status}`,
                            'NETWORK_ERROR',
                            'Verifica que la URL de Google Sheets sea accesible y est√© configurada para acceso p√∫blico.'
                        );
                    }
                    
                    const tsvText = await response.text();
                    console.log('Datos recibidos:', tsvText.substring(0, 100) + '...');
                    
                    const parsedData = parseTSV(tsvText);
                    console.log('Datos parseados:', parsedData.length, 'registros');
                    
                    if (parsedData.length === 0) {
                        throw new AppError(
                            APP_CONFIG.ERROR_MESSAGES.NO_DATA,
                            'NO_DATA',
                            'Verifica el formato del archivo TSV.'
                        );
                    }
                    
                    AppState.setFinancialData(parsedData);
                    financialData = parsedData; // Mantener alias para compatibilidad
                    
                    document.getElementById('loading').style.display = 'none';
                    updateCharts();
                    console.log('‚úÖ Datos cargados y charts actualizados correctamente');
                    
                } catch (error) {
                    document.getElementById('loading').style.display = 'none';
                    
                    // Si es un AppError, usar el manejador centralizado
                    if (error instanceof AppError) {
                        ErrorHandler.handle(error);
                    } else {
                        // Error desconocido
                        const appError = new AppError(
                            APP_CONFIG.ERROR_MESSAGES.LOAD_FAILED,
                            'UNKNOWN',
                            error.message
                        );
                        ErrorHandler.handle(appError);
                    }
                }
            }
            
            // --- GLOBAL FUNCTIONS & EVENT LISTENERS ---
            window.toggleCategory = function(category) {
                if (selectedCategories.has(category)) {
                    selectedCategories.delete(category);
                } else {
                    selectedCategories.add(category);
                }
                updateCharts();
            };

            // Enhanced click handler for category interactions from tables/charts.
            // - Ctrl/Cmd (metaKey) or Ctrl: toggle add/remove without affecting other selections
            // - Shift: select only the clicked category (clears others)
            // - Default click: toggle (add/remove) allowing multiple selections
            window.handleCategoryClick = function(event, category) {
                try {
                    // Ctrl/Cmd + click => multi-select toggle (add/remove without clearing others)
                    if (event && (event.metaKey || event.ctrlKey)) {
                        window.toggleCategory(category);
                        return;
                    }

                    // Shift or plain click => select only this category (clear others)
                    selectedCategories.clear();
                    selectedCategories.add(category);
                    updateCharts();
                } catch (err) {
                    // fallback to simple toggle
                    window.toggleCategory(category);
                }
            };

            window.toggleMonth = function(monthKey) {
                if (selectedMonths.has(monthKey)) {
                    selectedMonths.delete(monthKey);
                } else {
                    selectedMonths.add(monthKey);
                }
                updateCharts();
            };

            window.clearDateRange = function() {
                startDate = null;
                endDate = null;
                document.getElementById('start-date-select').value = '';
                document.getElementById('end-date-select').value = '';
                document.getElementById('filter-select').disabled = false;
                updateCharts();
            };

            window.clearAllFilters = function() {
                selectedCategories.clear();
                selectedMonths.clear();
                startDate = null;
                endDate = null;
                currentFilter = 'current_year';
                searchQuery = '';
                
                document.getElementById('filter-select').value = 'current_year';
                document.getElementById('filter-select').disabled = false;
                document.getElementById('start-date-select').value = '';
                document.getElementById('end-date-select').value = '';
                document.getElementById('transaction-search').value = '';
                
                updateCharts();
            };

            window.sortTable = function(column) {
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                createAllTransactionsTable(getFilteredData());
            };

            window.sortTopMovementsTable = function(column) {
                if (topMovementsSortColumn === column) {
                    topMovementsSortDirection = topMovementsSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    topMovementsSortColumn = column;
                    topMovementsSortDirection = 'asc';
                }
                // Re-render the table with current data
                const filteredData = getFilteredData();
                const topMovements = getTopMovements(filteredData);
                createTopMovementsTable(topMovements);
            };

            window.sortCategorySummaryTable = function(column) {
                if (categorySummarySortColumn === column) {
                    categorySummarySortDirection = categorySummarySortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    categorySummarySortColumn = column;
                    categorySummarySortDirection = 'asc';
                }
                // Re-render the table with current data
                createCategorySummaryTable(getFilteredData());
            };

            window.changePage = function(page) {
                currentPage = page;
                createAllTransactionsTable(getFilteredData());
            };

            window.exportToCSV = function() {
                const data = getFilteredData();
                if (data.length === 0) { alert(translate('no_data_export')); return; }
                
                // Solo exportar la columna que est√° visible seg√∫n el estado del toggle
                let headers, csvRows;
                
                if (secretColVisible) {
                    // Si la columna secreta est√° visible, exportar "Concepto (Original)"
                    headers = ['Tipo', 'F. Operativa', 'Concepto (Original)', 'Categoria', 'Mes A√±o', 'Gastos', 'Ingresos', 'per Home', 'Saldo'];
                    csvRows = data.map(item => {
                        const fecha = parseDate(item['F. Operativa']);
                        const fechaStr = fecha ? fecha.toLocaleDateString('es-ES') : '';
                        return [
                            `"${item.Tipo || ''}"`, `"${fechaStr}"`, 
                            `"${(item['Concepto (Original)'] || '').replace(/"/g, '""')}"`,
                            `"${item.Categoria || ''}"`, `"${item['Mes A√±o'] || ''}"`,
                            parseAmount(item.Gastos), parseAmount(item.Ingresos), parseAmount(item['per Home']), parseAmount(item.Saldo)
                        ].join(',');
                    });
                } else {
                    // Si la columna secreta est√° oculta, exportar "Concepto"
                    headers = ['Tipo', 'F. Operativa', 'Concepto', 'Categoria', 'Mes A√±o', 'Gastos', 'Ingresos', 'per Home', 'Saldo'];
                    csvRows = data.map(item => {
                        const fecha = parseDate(item['F. Operativa']);
                        const fechaStr = fecha ? fecha.toLocaleDateString('es-ES') : '';
                        return [
                            `"${item.Tipo || ''}"`, `"${fechaStr}"`, 
                            `"${(item.Concepto || '').replace(/"/g, '""')}"`,
                            `"${item.Categoria || ''}"`, `"${item['Mes A√±o'] || ''}"`,
                            parseAmount(item.Gastos), parseAmount(item.Ingresos), parseAmount(item['per Home']), parseAmount(item.Saldo)
                        ].join(',');
                    });
                }
                
                const csvContent = [headers.join(','), ...csvRows].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `transacciones_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            document.getElementById('filter-select').addEventListener('change', function() {
                currentFilter = this.value;
                updateCharts();
            });

            document.getElementById('start-date-select').addEventListener('change', function() {
                startDate = this.value ? new Date(this.value + '-01T00:00:00Z') : null;
                updateCharts();
            });

            document.getElementById('end-date-select').addEventListener('change', function() {
                 if (this.value) {
                    const [year, month] = this.value.split('-');
                    endDate = new Date(Date.UTC(year, month, 0, 23, 59, 59, 999)); // End of the selected month
                } else {
                    endDate = null;
                }
                updateCharts();
            });

            // B√∫squeda con debounce para optimizar rendimiento
            const handleSearch = debounce(function(value) {
                searchQuery = value;
                AppState.setSearchQuery(value);
                currentPage = 1;
                AppState.setPage(1);
                createAllTransactionsTable(getFilteredData());
                console.log('üîç B√∫squeda aplicada:', value);
            }, APP_CONFIG.SEARCH_DEBOUNCE_DELAY);

            document.getElementById('transaction-search').addEventListener('input', function(e) {
                handleSearch(e.target.value);
            });

            /**
             * Traduce una clave al idioma actual
             * @param {string} key - Clave de traducci√≥n
             * @returns {string} Texto traducido o la clave si no existe traducci√≥n
             */
            function translate(key) {
                return translations[currentLanguage][key] || key;
            }

            function updateLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('dashboardLanguage', lang);
                
                // Actualizar t√≠tulos de secciones
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    element.textContent = translate(key);
                });

                // Update placeholders, titles and button labels not covered by data-i18n attributes
                const searchInput = document.getElementById('transaction-search');
                if (searchInput) searchInput.placeholder = translate('search_by_concept');

                const fab = document.getElementById('clear-filters-fab');
                if (fab) fab.title = translate('clear_all_title');

                // Dashboard title (not using data-i18n directly to preserve layout)
                const dashTitle = document.getElementById('dashboard-title');
                if (dashTitle) dashTitle.textContent = translate('dashboard_title');
                const dashSubtitle = document.getElementById('dashboard-subtitle');
                if (dashSubtitle) dashSubtitle.textContent = translate('dashboard_subtitle');

                const exportBtn = document.querySelector('[data-i18n="export_csv"]');
                if (exportBtn) exportBtn.textContent = translate('export_csv');

                // Forzar actualizaci√≥n de tablas para actualizar encabezados
                updateCharts();
            }

            document.getElementById('language-select').addEventListener('change', function() {
                updateLanguage(this.value);
            });

            // Establecer el idioma inicial
            document.getElementById('language-select').value = currentLanguage;

            // Apply translations immediately
            updateLanguage(currentLanguage);

            loadData();
// Establecer el idioma inicial
¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('language-select').value = currentLanguage;

            // --- A√ëADIR ESTE BLOQUE ---
            // --- L√ìGICA PARA COLUMNA SECRETA (MEJORADA) ---
            // Guardamos s√≥lo el hash en el c√≥digo. Si quieres cambiar la contrase√±a,
            // genera un nuevo hash con la funci√≥n indicada y reemplaza PASSWORD_HASH.
            const PASSWORD_HASH = 'ad13b54afdc157f7e506ced0df9a4d70f2f19b2fd8ba9d4d419e996c96d64061'; 
            let secretColVisible = false;

            // Calcula SHA-256 y devuelve hex
            async function sha256(message) {
                if (message == null) return '';
                const msgBuffer = new TextEncoder().encode(message);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
            // Muestra un di√°logo modal con input de tipo password y devuelve la contrase√±a o null si se cancela
            function showPasswordModal(message) {
                return new Promise(resolve => {
                    // Overlay
                    const overlay = document.createElement('div');
                    overlay.style.position = 'fixed';
                    overlay.style.inset = '0';
                    overlay.style.background = 'rgba(0,0,0,0.35)';
                    overlay.style.display = 'flex';
                    overlay.style.alignItems = 'center';
                    overlay.style.justifyContent = 'center';
                    overlay.style.zIndex = '2000';

                    // Modal
                    const modal = document.createElement('div');
                    modal.style.background = 'white';
                    modal.style.padding = '18px';
                    modal.style.borderRadius = '8px';
                    modal.style.boxShadow = '0 8px 24px rgba(0,0,0,0.2)';
                    modal.style.width = '320px';
                    modal.style.maxWidth = '90%';
                    modal.style.fontFamily = 'inherit';

                    const title = document.createElement('div');
                    title.textContent = message || 'Introduce la contrase√±a';
                    title.style.marginBottom = '8px';
                    title.style.fontWeight = '600';

                    const input = document.createElement('input');
                    input.type = 'password';
                    input.style.width = '100%';
                    input.style.padding = '10px';
                    input.style.marginBottom = '12px';
                    input.style.border = '1px solid #ccc';
                    input.style.borderRadius = '6px';
                    input.autocomplete = 'new-password';

                    const buttons = document.createElement('div');
                    buttons.style.display = 'flex';
                    buttons.style.justifyContent = 'flex-end';
                    buttons.style.gap = '8px';

                    const cancelBtn = document.createElement('button');
                    cancelBtn.textContent = 'Cancelar';
                    cancelBtn.style.padding = '8px 12px';
                    cancelBtn.style.background = '#f1f1f1';
                    cancelBtn.style.border = 'none';
                    cancelBtn.style.borderRadius = '6px';
                    cancelBtn.style.cursor = 'pointer';

                    const okBtn = document.createElement('button');
                    okBtn.textContent = 'Aceptar';
                    okBtn.style.padding = '8px 12px';
                    okBtn.style.background = 'var(--color-balance)';
                    okBtn.style.color = 'white';
                    okBtn.style.border = 'none';
                    okBtn.style.borderRadius = '6px';
                    okBtn.style.cursor = 'pointer';

                    buttons.appendChild(cancelBtn);
                    buttons.appendChild(okBtn);

                    modal.appendChild(title);
                    modal.appendChild(input);
                    modal.appendChild(buttons);
                    overlay.appendChild(modal);
                    document.body.appendChild(overlay);

                    // Focus
                    setTimeout(() => input.focus(), 50);

                    function cleanup() {
                        overlay.remove();
                    }

                    cancelBtn.addEventListener('click', () => {
                        cleanup();
                        resolve(null);
                    });

                    okBtn.addEventListener('click', () => {
                        const val = input.value;
                        cleanup();
                        resolve(val);
                    });

                    overlay.addEventListener('click', (e) => {
                        if (e.target === overlay) {
                            cleanup();
                            resolve(null);
                        }
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            okBtn.click();
                        } else if (e.key === 'Escape') {
                            cancelBtn.click();
                        }
                    });
                });
            }

            // toggleSecretColumn ahora utiliza un modal con input type=password para no mostrar la contrase√±a en pantalla
            async function toggleSecretColumn() {
                const tableContainer = document.getElementById('all-transactions-table');
                const icon = document.getElementById('toggle-secret-col');

                if (secretColVisible) {
                    // Si ya est√° visible, ocultarla
                    tableContainer.classList.remove('show-secret-col');
                    secretColVisible = false;
                    if (icon) icon.style.opacity = '0.6';
                } else {
                    // Pedir contrase√±a en modal (input enmascarado)
                    const pass = await showPasswordModal(translate('enter_password_concept'));
                    if (pass === null) return; // usuario cancel√≥

                    const hashedPass = await sha256(pass);
                    console.log('Hash ingresado:', hashedPass);
                    console.log('Hash esperado:', PASSWORD_HASH);
                    console.log('Contrase√±a ingresada:', pass);
                    // Validar solo comparando el hash
                    if (hashedPass === PASSWORD_HASH) {
                        tableContainer.classList.add('show-secret-col');
                        secretColVisible = true;
                        if (icon) icon.style.opacity = '1';
                    } else {
                        // Usar un alert simple para notificar
                        alert('Contrase√±a incorrecta.');
                    }
                }
            }

            // Usar un wrapper para manejar la funci√≥n as√≠ncrona desde el listener
            document.getElementById('toggle-secret-col').addEventListener('click', function() { toggleSecretColumn(); });
            // --- FIN L√ìGICA SECRETA ---
            
¬† ¬† ¬† ¬† ¬† ¬† // Apply translations immediately
¬† ¬† ¬† ¬† ¬† ¬† updateLanguage(currentLanguage);
        })();
    </script>
</body>

</html>
